rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Get user's organization from custom claims
    function getUserOrgId() {
      return request.auth.token.organizationId;
    }

    // Helper: Check if document belongs to user's organization
    function isOrgMember(orgId) {
      return isAuthenticated() && getUserOrgId() == orgId;
    }

    // Helper: Check if user is org admin (owner or administrator)
    function isOrgAdmin(orgId) {
      return isOrgMember(orgId) &&
        request.auth.token.role in ['owner', 'administrator'];
    }

    // Users collection - users can read/write their own document
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Organizations collection - members can read, admins can write
    match /organizations/{orgId} {
      allow read: if isOrgMember(orgId);
      allow write: if isOrgAdmin(orgId);
    }

    // Organization members - members can read, admins can manage
    match /organization_members/{memberId} {
      allow read: if isAuthenticated() &&
        (isOrgMember(resource.data.organizationId) ||
         request.auth.uid == resource.data.userId);
      allow create: if isOrgAdmin(request.resource.data.organizationId);
      allow update, delete: if isOrgAdmin(resource.data.organizationId);
    }

    // Employees - org members can read, admins can write
    match /employees/{employeeId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isOrgAdmin(request.resource.data.organizationId);
      allow update, delete: if isOrgAdmin(resource.data.organizationId);
    }

    // Integrations - org members can read, admins can manage
    match /integrations/{integrationId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isOrgAdmin(request.resource.data.organizationId);
      allow update, delete: if isOrgAdmin(resource.data.organizationId);
    }

    // Webhook queue - server-side only (no client access)
    match /webhook_queue/{queueId} {
      allow read, write: if false;
    }

    // Processed events - server-side only (no client access)
    // Note: processed_stripe_events kept separate for clarity
    match /processed_events/{eventId} {
      allow read, write: if false;
    }

    match /processed_stripe_events/{eventId} {
      allow read, write: if false;
    }

    // Newsletter signups - public create, admin read
    match /newsletter/{docId} {
      allow create: if true;
      allow read: if false; // Admin access via server only
    }

    // Tokens (refresh tokens, etc) - server-side only
    match /tokens/{tokenId} {
      allow read, write: if false;
    }

    // Calendar events - org members can read, admins can write (or service account)
    match /calendar_events/{eventId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isOrgAdmin(request.resource.data.organizationId);
      allow update, delete: if isOrgAdmin(resource.data.organizationId);
    }

    // Sync states - server-side only (tracks sync tokens per integration)
    match /sync_states/{stateId} {
      allow read, write: if false;
    }
  }
}
