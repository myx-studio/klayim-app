---
phase: 01-user-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/ui/stepper.tsx
  - packages/shared/src/schemas/auth.ts
  - packages/shared/src/schemas/organization.ts
  - apps/api/src/routes/organization.route.ts
  - apps/api/src/services/organization.service.ts
autonomous: true
requirements:
  - UONB-03

must_haves:
  truths:
    - "Stepper component renders steps with correct visual states (completed, active, pending)"
    - "Password schema requires special character in addition to existing requirements"
    - "Organization name schema validates 2-50 chars with alphanumeric/spaces/hyphens"
    - "API endpoint returns organization name availability status"
  artifacts:
    - path: "apps/web/src/components/ui/stepper.tsx"
      provides: "Reusable Stepper component with CVA styling"
      min_lines: 80
    - path: "packages/shared/src/schemas/auth.ts"
      provides: "Extended password schema with special character requirement"
      contains: "onboardingPasswordSchema"
    - path: "packages/shared/src/schemas/organization.ts"
      provides: "Organization name validation schema"
      contains: "organizationNameSchema"
    - path: "apps/api/src/routes/organization.route.ts"
      provides: "Name availability check endpoint"
      contains: "check-name"
  key_links:
    - from: "apps/web/src/components/ui/stepper.tsx"
      to: "class-variance-authority"
      via: "CVA variants for step states"
      pattern: "cva\\("
    - from: "apps/api/src/routes/organization.route.ts"
      to: "apps/api/src/services/organization.service.ts"
      via: "checkNameAvailability call"
      pattern: "organizationService\\.checkNameAvailability"
---

<objective>
Create foundational components and schemas for user onboarding flow.

Purpose: Establish reusable building blocks (Stepper component, validation schemas, API endpoint) that the onboarding forms will consume.

Output:
- Stepper UI component with completed/active/pending states
- Extended password schema with special character requirement
- Organization name validation schema
- API endpoint for organization name availability check
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01/CONTEXT.md
@.planning/phases/01/01-RESEARCH.md

# Existing patterns to follow
@apps/web/src/components/pages/auth/signin/index.tsx
@packages/shared/src/schemas/auth.ts
@packages/shared/src/schemas/organization.ts
@apps/api/src/services/organization.service.ts
@apps/api/src/routes/organization.route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stepper UI Component</name>
  <files>apps/web/src/components/ui/stepper.tsx</files>
  <action>
Create a reusable Stepper component following the existing shadcn/UI patterns in the project.

**Component Structure:**
```typescript
// Step type definition
interface Step {
  id: string;
  label: string;
  href?: string;
}

// Props
interface StepperProps {
  steps: Step[];
  currentStep: number; // 0-indexed
  onStepClick?: (stepIndex: number) => void;
  className?: string;
}
```

**Visual States (per user decision):**
- **Completed:** Checkmark icon + filled background (green/primary), clickable
- **Active:** Highlighted border/ring, current step indicator
- **Pending:** Muted/disabled appearance, not clickable

**Implementation Details:**
1. Use CVA (class-variance-authority) for step state variants - pattern exists in other UI components
2. Use `lucide-react` Check icon for completed state (already in project)
3. Use `cn()` utility from existing pattern for class merging
4. Add horizontal connector lines between steps
5. Mobile responsive: Show "Step X of Y" text format when viewport < md breakpoint (per user decision)
6. Support keyboard navigation for accessibility

**CVA Variants:**
```typescript
const stepVariants = cva(
  "flex items-center justify-center rounded-full transition-colors",
  {
    variants: {
      state: {
        completed: "bg-primary text-primary-foreground cursor-pointer hover:bg-primary/90",
        active: "border-2 border-primary bg-background text-primary",
        pending: "bg-muted text-muted-foreground cursor-not-allowed",
      },
      size: {
        default: "h-10 w-10",
        sm: "h-8 w-8",
      },
    },
    defaultVariants: {
      state: "pending",
      size: "default",
    },
  }
);
```

**Mobile View:**
- Below md breakpoint, render compact version: "Step {current} of {total}: {currentLabel}"
- Use `useMediaQuery` or CSS-only approach with Tailwind's responsive classes

Export: `Stepper` component as named export
  </action>
  <verify>
- Component file exists at apps/web/src/components/ui/stepper.tsx
- Imports CVA and lucide-react Check icon
- Has StepperProps interface with steps, currentStep, onStepClick
- Has three visual states: completed, active, pending
- Has responsive mobile view
- TypeScript compiles without errors: `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm --filter @klayim/web exec tsc --noEmit`
  </verify>
  <done>
Stepper component renders steps with completed (checkmark + filled), active (highlighted), and pending (muted) states. Mobile shows "Step X of Y" format. Completed steps are clickable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend Validation Schemas</name>
  <files>
packages/shared/src/schemas/auth.ts
packages/shared/src/schemas/organization.ts
  </files>
  <action>
**In packages/shared/src/schemas/auth.ts:**

Add `onboardingPasswordSchema` that extends the existing `passwordSchema` with special character requirement (per user decision):

```typescript
// Special characters allowed in password
export const onboardingPasswordSchema = passwordSchema
  .regex(
    /[!@#$%^&*(),.?":{}|<>]/,
    "Password must contain at least one special character"
  );

// Schema for onboarding complete profile form (with confirm password)
export const onboardingCompleteProfileSchema = z
  .object({
    name: nameSchema,
    password: onboardingPasswordSchema,
    confirmPassword: z.string().min(1, "Please confirm your password"),
  })
  .refine((data) => data.password === data.confirmPassword, {
    message: "Passwords do not match",
    path: ["confirmPassword"],
  });

export type OnboardingCompleteProfileInput = z.infer<typeof onboardingCompleteProfileSchema>;
```

Also export the individual password requirements for the checklist component:
```typescript
export const PASSWORD_REQUIREMENTS = [
  { id: "length", label: "At least 8 characters", test: (p: string) => p.length >= 8 },
  { id: "uppercase", label: "One uppercase letter", test: (p: string) => /[A-Z]/.test(p) },
  { id: "lowercase", label: "One lowercase letter", test: (p: string) => /[a-z]/.test(p) },
  { id: "number", label: "One number", test: (p: string) => /[0-9]/.test(p) },
  { id: "special", label: "One special character", test: (p: string) => /[!@#$%^&*(),.?":{}|<>]/.test(p) },
] as const;
```

**In packages/shared/src/schemas/organization.ts:**

Add organization name validation schema (per user decision - 2-50 chars, alphanumeric/spaces/hyphens, globally unique check happens via API):

```typescript
export const organizationNameSchema = z
  .string()
  .min(2, "Name must be at least 2 characters")
  .max(50, "Name must be at most 50 characters")
  .regex(
    /^[a-zA-Z0-9\s-]+$/,
    "Only letters, numbers, spaces, and hyphens allowed"
  )
  .refine(
    (val) => /[a-zA-Z0-9]/.test(val),
    "Name must contain at least one letter or number"
  )
  .transform((val) => val.trim());

// Schema for creating organization during onboarding (name only, slug auto-generated)
export const onboardingCreateOrganizationSchema = z.object({
  name: organizationNameSchema,
});

export type OnboardingCreateOrganizationInput = z.infer<typeof onboardingCreateOrganizationSchema>;
```

Update the index.ts exports if needed.
  </action>
  <verify>
- Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm --filter @klayim/shared exec tsc --noEmit`
- Verify exports: `grep -l "onboardingPasswordSchema\|organizationNameSchema" packages/shared/src/schemas/*.ts`
- Test schema validation mentally: "Test123!" should pass onboardingPasswordSchema, "Test123" should fail (no special char)
  </verify>
  <done>
- onboardingPasswordSchema requires 8+ chars, uppercase, lowercase, number, AND special character
- onboardingCompleteProfileSchema validates name + password + confirmPassword with match check
- PASSWORD_REQUIREMENTS array exported for use in checklist component
- organizationNameSchema validates 2-50 chars, alphanumeric/spaces/hyphens only, requires at least one letter/number, trims whitespace
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Organization Name Availability Endpoint</name>
  <files>
apps/api/src/services/organization.service.ts
apps/api/src/routes/organization.route.ts
  </files>
  <action>
**In apps/api/src/services/organization.service.ts:**

Add a method to check organization name availability. Names become slugs internally, so check slug availability:

```typescript
async checkNameAvailability(name: string): Promise<{ available: boolean; suggestion?: string }> {
  // Generate slug from name
  const slug = this.generateSlug(name);

  // Check if slug is available
  const isAvailable = await organizationRepository.isSlugAvailable(slug);

  if (isAvailable) {
    return { available: true };
  }

  // Generate suggestion by appending number
  let suggestion = slug;
  let counter = 1;
  while (!(await organizationRepository.isSlugAvailable(`${slug}-${counter}`))) {
    counter++;
    if (counter > 10) break; // Safety limit
  }
  if (counter <= 10) {
    suggestion = `${slug}-${counter}`;
  }

  return { available: false, suggestion };
}

private generateSlug(name: string): string {
  return name
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
}
```

**In apps/api/src/routes/organization.route.ts:**

Add GET endpoint for name availability check. This endpoint should NOT require authentication (users check name before creating org):

```typescript
import { z } from "zod";

// Add at the TOP of the routes (before auth-required routes)
// GET /organizations/check-name?name=... - Check name availability (public)
organizations.get(
  "/check-name",
  zValidator("query", z.object({ name: z.string().min(2).max(50) })),
  async (c) => {
    const { name } = c.req.valid("query");
    const result = await organizationService.checkNameAvailability(name);

    return c.json<ApiResponse<{ available: boolean; suggestion?: string }>>({
      success: true,
      data: result,
    });
  }
);
```

**IMPORTANT:** Place this route BEFORE the `/:id` route to prevent "check-name" being interpreted as an ID.
  </action>
  <verify>
- API compiles: `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm --filter @klayim/api exec tsc --noEmit`
- Start API locally and test: `curl "http://localhost:3001/api/v1/organizations/check-name?name=TestOrg"` should return `{"success":true,"data":{"available":true}}` (or false with suggestion if name taken)
  </verify>
  <done>
- GET /api/v1/organizations/check-name endpoint exists
- Accepts `name` query parameter (2-50 chars)
- Returns `{ available: boolean, suggestion?: string }`
- Generates slug from name and checks availability
- Suggests alternative name if taken (e.g., "myorg-1")
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles for all packages: `pnpm run typecheck` (if available) or run tsc in each package
2. Stepper component can be imported: `import { Stepper } from "@/components/ui/stepper"`
3. Schemas can be imported: `import { onboardingPasswordSchema, PASSWORD_REQUIREMENTS } from "@klayim/shared/schemas"`
4. API endpoint responds to name availability check
</verification>

<success_criteria>
- [ ] Stepper component exists with completed/active/pending states
- [ ] Stepper shows "Step X of Y" on mobile
- [ ] onboardingPasswordSchema requires special character
- [ ] PASSWORD_REQUIREMENTS array exported
- [ ] organizationNameSchema validates name format
- [ ] GET /organizations/check-name returns availability
- [ ] All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01/01-01-SUMMARY.md`
</output>
