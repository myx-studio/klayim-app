---
phase: 08-governance-configuration
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - apps/web/src/hooks/use-organization.ts
  - apps/web/src/components/pages/onboarding/configure-governance/index.tsx
autonomous: true
requirements: [GOV-01, GOV-02, GOV-04, GOV-05, GOV-06]

must_haves:
  truths:
    - "User can set meeting cost threshold"
    - "User can set low ROI threshold"
    - "User can configure dashboard refresh interval"
    - "User can enable/disable pull-to-refresh"
    - "Settings persist across page refresh"
  artifacts:
    - path: "apps/web/src/hooks/use-organization.ts"
      provides: "useUpdateGovernance mutation hook"
      exports: ["useUpdateGovernance"]
    - path: "apps/web/src/components/pages/onboarding/configure-governance/index.tsx"
      provides: "Governance form with API integration"
      contains: "useUpdateGovernance"
  key_links:
    - from: "apps/web/src/components/pages/onboarding/configure-governance/index.tsx"
      to: "apps/web/src/hooks/use-organization.ts"
      via: "useUpdateGovernance hook"
      pattern: "useUpdateGovernance"
    - from: "apps/web/src/components/pages/onboarding/configure-governance/index.tsx"
      to: "/api/organizations/:id/governance"
      via: "mutation fetch call"
      pattern: "PATCH.*governance"
---

<objective>
Wire the configure-governance UI to persist settings via API.

Purpose: Complete GOV requirements by connecting the existing form to the backend and using react-hook-form for proper validation.

Output: Working governance configuration page that saves to database.
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-governance-configuration/08-RESEARCH.md
@.planning/phases/08-governance-configuration/08-01-SUMMARY.md
@apps/web/src/hooks/use-organization.ts
@apps/web/src/components/pages/onboarding/configure-governance/index.tsx
@apps/web/src/components/pages/onboarding/plan-selection/enterprise-form.tsx (for react-hook-form pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add useUpdateGovernance mutation hook</name>
  <files>
    apps/web/src/hooks/use-organization.ts
  </files>
  <action>
In apps/web/src/hooks/use-organization.ts:
- Add import for useQueryClient from @tanstack/react-query
- Add import for GovernanceSettings type from @klayim/shared/types
- Add useUpdateGovernance mutation hook:
  - mutationFn accepts { id: string, data: GovernanceSettingsInput } where GovernanceSettingsInput is the API input shape
  - Call fetcher with PATCH to `/organizations/${id}/governance`
  - Body is JSON.stringify(data)
  - Check response.success, throw FetchError if false
  - Return response.data (the updated GovernanceSettings)
  - In onSuccess callback, call queryClient.invalidateQueries({ queryKey: ["organization"] }) to refresh organization data

Note: GovernanceSettingsInput should match what the API expects (all fields required):
{
  meetingCostThresholdCents: number,
  lowRoiThreshold: number,
  dashboardRefreshMinutes: number,
  pullToRefreshEnabled: boolean
}
  </action>
  <verify>
cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm exec tsc --noEmit -p apps/web/tsconfig.json
  </verify>
  <done>
useUpdateGovernance hook exported from use-organization.ts, TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire configure-governance page to API with react-hook-form</name>
  <files>
    apps/web/src/components/pages/onboarding/configure-governance/index.tsx
  </files>
  <action>
Rewrite the configure-governance page to use react-hook-form and the API:

1. Add imports:
   - useForm from react-hook-form
   - zodResolver from @hookform/resolvers/zod
   - z from zod
   - useUpdateGovernance and useOrganization from @/hooks/use-organization
   - toast from sonner

2. Define local form schema (for UI validation):
   ```typescript
   const governanceFormSchema = z.object({
     meetingCostThreshold: z.coerce.number().min(0).max(100000),  // dollars in UI
     lowRoiThreshold: z.coerce.number().min(0).max(100),
     dashboardRefresh: z.string(),  // "15", "30", "60", "120" from Select
     pullToRefresh: z.boolean(),
   });
   ```

3. Use useOrganization to get current organization and load existing settings.

4. Use useForm with zodResolver:
   ```typescript
   const { register, handleSubmit, formState: { errors, isSubmitting }, setValue, watch } = useForm({
     resolver: zodResolver(governanceFormSchema),
     defaultValues: {
       meetingCostThreshold: organization?.governanceSettings?.meetingCostThresholdCents
         ? organization.governanceSettings.meetingCostThresholdCents / 100
         : 500,
       lowRoiThreshold: organization?.governanceSettings?.lowRoiThreshold ?? 1.0,
       dashboardRefresh: String(organization?.governanceSettings?.dashboardRefreshMinutes ?? 30),
       pullToRefresh: organization?.governanceSettings?.pullToRefreshEnabled ?? true,
     },
   });
   ```

5. Add useUpdateGovernance mutation.

6. Create onSubmit handler:
   - Convert meetingCostThreshold (dollars) to meetingCostThresholdCents (cents) by multiplying by 100
   - Convert dashboardRefresh string to number
   - Call mutation with organization ID and transformed data
   - On success: show toast("Settings saved"), navigate to onboarding-success
   - On error: show toast.error("Failed to save settings")

7. Update existing fields to use react-hook-form:
   - Meeting Cost Threshold: use register("meetingCostThreshold")
   - Low ROI Threshold: use register("lowRoiThreshold")
   - Dashboard Refresh: use setValue/watch for Select component (not register)
   - Pull to Refresh: use setValue/watch for Checkbox component

8. Replace handleNext with handleSubmit(onSubmit):
   - onNext prop of OrgOnboardingLayout should be handleSubmit(onSubmit)
   - Remove old local state (useState calls)

9. Handle loading state:
    - Disable form while isSubmitting
    - Show loading indicator on Complete Setup button

Note: Be careful with controlled vs uncontrolled components:
- For Select: use watch("dashboardRefresh") for value, setValue on onValueChange
- For Checkbox: use watch("pullToRefresh") for checked, setValue on onCheckedChange
  </action>
  <verify>
cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm exec tsc --noEmit -p apps/web/tsconfig.json && pnpm --filter web run build
  </verify>
  <done>
- Configure governance page uses react-hook-form with Zod validation
- All 4 governance fields editable (GOV-01, GOV-02, GOV-04, GOV-05)
- Form submits to API and persists settings (GOV-06)
- Existing settings load as default values
- Success toast shows after save
- Web app builds without errors
  </done>
</task>

</tasks>

<verification>
1. Web compiles: `pnpm exec tsc --noEmit -p apps/web/tsconfig.json`
2. Web builds: `pnpm --filter web run build`
3. Manual test flow:
   - Navigate to /onboarding/configure-governance
   - Change meeting cost threshold to $750
   - Change low ROI threshold to 1.5
   - Change dashboard refresh to 60 minutes
   - Toggle pull-to-refresh off
   - Click "Complete Setup"
   - Verify toast shows "Settings saved"
   - Refresh page and verify values persisted
</verification>

<success_criteria>
- Governance requirements (GOV-01, GOV-02, GOV-04, GOV-05, GOV-06) satisfied
- Form validates input (number ranges)
- Settings save to API on "Complete Setup"
- Settings persist and reload on page refresh
- Success/error toasts provide feedback
- No TypeScript errors, web app builds
</success_criteria>

<output>
After completion, create `.planning/phases/08-governance-configuration/08-02-SUMMARY.md`
</output>
