---
phase: 08-governance-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/types/organization.ts
  - packages/shared/src/schemas/organization.ts
  - apps/api/src/repositories/organization.repository.ts
  - apps/api/src/services/organization.service.ts
  - apps/api/src/routes/organization.route.ts
autonomous: true
requirements: [GOV-01, GOV-02, GOV-03, GOV-04, GOV-05, GOV-06]

must_haves:
  truths:
    - "API accepts governance settings and persists to organization"
    - "API validates input with appropriate constraints"
    - "Only owner/administrator can update governance settings"
  artifacts:
    - path: "packages/shared/src/types/organization.ts"
      provides: "GovernanceSettings interface"
      contains: "interface GovernanceSettings"
    - path: "packages/shared/src/schemas/organization.ts"
      provides: "Zod validation schema"
      exports: ["governanceSettingsSchema"]
    - path: "apps/api/src/routes/organization.route.ts"
      provides: "PATCH /:id/governance endpoint"
      contains: "/:id/governance"
  key_links:
    - from: "apps/api/src/routes/organization.route.ts"
      to: "apps/api/src/services/organization.service.ts"
      via: "organizationService.updateGovernanceSettings"
      pattern: "updateGovernanceSettings"
    - from: "apps/api/src/services/organization.service.ts"
      to: "apps/api/src/repositories/organization.repository.ts"
      via: "organizationRepository.updateGovernance"
      pattern: "updateGovernance"
---

<objective>
Add backend infrastructure for governance settings persistence.

Purpose: Enable the configure-governance page to save settings to the database, completing GOV-06 (settings persist per organization).

Output: PATCH /organizations/:id/governance endpoint with validation, authorization, and persistence.
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-governance-configuration/08-RESEARCH.md
@packages/shared/src/types/organization.ts
@packages/shared/src/schemas/organization.ts
@apps/api/src/repositories/organization.repository.ts
@apps/api/src/services/organization.service.ts
@apps/api/src/routes/organization.route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GovernanceSettings type and Zod schema</name>
  <files>
    packages/shared/src/types/organization.ts
    packages/shared/src/schemas/organization.ts
  </files>
  <action>
In packages/shared/src/types/organization.ts:
- Add new interface GovernanceSettings with these fields:
  - meetingCostThresholdCents: number (stored as integer cents, e.g., 50000 = $500)
  - lowRoiThreshold: number (decimal, e.g., 1.0)
  - approvalEmail: string (email for approval routing)
  - dashboardRefreshMinutes: number (15, 30, 60, or 120)
  - pullToRefreshEnabled: boolean
- Add governanceSettings?: GovernanceSettings to Organization interface (alongside existing timeGovernance)
- Keep existing TimeGovernanceSettings interface untouched (may be used in v2)

In packages/shared/src/schemas/organization.ts:
- Add governanceSettingsSchema with validation:
  - meetingCostThresholdCents: z.number().int().min(0).max(10000000) (0 to $100,000)
  - lowRoiThreshold: z.number().min(0).max(100) (0 to 100x)
  - approvalEmail: z.string().email().or(z.literal("")) (allow empty string for optional)
  - dashboardRefreshMinutes: z.number().refine(val => [15, 30, 60, 120].includes(val))
  - pullToRefreshEnabled: z.boolean()
- Export type GovernanceSettingsInput = z.infer<typeof governanceSettingsSchema>
  </action>
  <verify>
cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm exec tsc --noEmit -p packages/shared/tsconfig.json
  </verify>
  <done>
GovernanceSettings interface exists in organization.ts, governanceSettingsSchema exported from organization.ts schemas, TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add repository and service methods</name>
  <files>
    apps/api/src/repositories/organization.repository.ts
    apps/api/src/services/organization.service.ts
  </files>
  <action>
In apps/api/src/repositories/organization.repository.ts:
- Add import for GovernanceSettings type from @klayim/shared/types
- Add method updateGovernance(id: string, settings: GovernanceSettings): Promise<Organization | null>
  - Get document, return null if not exists
  - Update with { governanceSettings: settings, updatedAt: new Date().toISOString() }
  - Return updated organization via findById
- Update mapToOrganization to include governanceSettings field

In apps/api/src/services/organization.service.ts:
- Add import for GovernanceSettings type
- Add method updateGovernanceSettings(id: string, settings: GovernanceSettings, userId: string): Promise<Organization | { error: string }>
  - Check permission: only owner or administrator can update
  - Call organizationRepository.updateGovernance
  - Return error if organization not found
  </action>
  <verify>
cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm exec tsc --noEmit -p apps/api/tsconfig.json
  </verify>
  <done>
Repository has updateGovernance method, service has updateGovernanceSettings method with permission check, TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add PATCH endpoint for governance settings</name>
  <files>
    apps/api/src/routes/organization.route.ts
  </files>
  <action>
In apps/api/src/routes/organization.route.ts:
- Add import for governanceSettingsSchema from @klayim/shared/schemas
- Add import for GovernanceSettings type from @klayim/shared/types
- Add PATCH /:id/governance endpoint after existing PATCH /:id endpoint:
  - Use zValidator("json", governanceSettingsSchema) for validation
  - Check userId from context, return 401 if not present
  - Call organizationService.updateGovernanceSettings(id, input, userId)
  - Return 403 for "Permission denied", 400 for other errors
  - Return 200 with ApiResponse<GovernanceSettings> containing the updated settings

Note: Place this route after /:id PATCH to avoid conflicts. The path /:id/governance is more specific and will match correctly.
  </action>
  <verify>
cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm exec tsc --noEmit -p apps/api/tsconfig.json && pnpm --filter api run build
  </verify>
  <done>
PATCH /:id/governance endpoint exists with validation and authorization, API builds successfully.
  </done>
</task>

</tasks>

<verification>
1. Types compile: `pnpm exec tsc --noEmit -p packages/shared/tsconfig.json`
2. API compiles and builds: `pnpm --filter api run build`
3. Manual test with curl (after starting API):
   - `curl -X PATCH http://localhost:3000/organizations/{orgId}/governance -H "Content-Type: application/json" -H "Authorization: Bearer {token}" -d '{"meetingCostThresholdCents": 50000, "lowRoiThreshold": 1.0, "approvalEmail": "approvals@example.com", "dashboardRefreshMinutes": 30, "pullToRefreshEnabled": true}'`
</verification>

<success_criteria>
- GovernanceSettings interface defined in shared types
- governanceSettingsSchema validates all fields correctly
- PATCH /organizations/:id/governance endpoint exists
- Only owner/administrator can update settings (403 for others)
- Settings persist to Firestore organization document
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-governance-configuration/08-01-SUMMARY.md`
</output>
