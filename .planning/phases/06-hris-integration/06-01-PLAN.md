---
phase: 06-hris-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/services/bamboohr.service.ts
  - apps/api/src/services/hris-sync.service.ts
  - apps/api/src/routes/oauth/bamboohr.ts
  - apps/api/src/routes/oauth/index.ts
  - apps/api/src/services/index.ts
  - apps/api/src/services/token-refresh.service.ts
autonomous: true
requirements: [HRIS-01, HRIS-05, HRIS-06]

must_haves:
  truths:
    - "User can connect BambooHR via OAuth flow"
    - "User must provide BambooHR company subdomain before OAuth"
    - "System imports employees with name, email, role, department, hourly rate"
    - "System calculates hourly rate from salary if hourly not provided"
  artifacts:
    - path: "apps/api/src/services/bamboohr.service.ts"
      provides: "BambooHR OAuth and employee fetch"
      exports: ["bambooHRService", "BambooHRExchangeResult"]
    - path: "apps/api/src/services/hris-sync.service.ts"
      provides: "Employee sync orchestration from HRIS"
      exports: ["hrisSyncService"]
    - path: "apps/api/src/routes/oauth/bamboohr.ts"
      provides: "BambooHR OAuth routes"
      exports: ["bambooHROAuth"]
  key_links:
    - from: "apps/api/src/routes/oauth/bamboohr.ts"
      to: "apps/api/src/services/bamboohr.service.ts"
      via: "service import"
      pattern: "bambooHRService\\."
    - from: "apps/api/src/services/hris-sync.service.ts"
      to: "apps/api/src/repositories/employee.repository.ts"
      via: "upsertBySourceId"
      pattern: "employeeRepository\\.upsertBySourceId"
---

<objective>
BambooHR OAuth integration enabling users to connect their HR system and import employee data.

Purpose: Enable BambooHR users to import employee data (names, emails, roles, departments, hourly rates) for meeting cost calculation. BambooHR uses direct OAuth 2.0 (not Finch) since it has good native OAuth support.

Output: BambooHR service with OAuth flow, OAuth routes following existing Google/Microsoft pattern, and HRIS sync service that transforms employee data and saves to Firestore.
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-hris-integration/06-RESEARCH.md
@apps/api/src/services/google-calendar.service.ts (OAuth pattern reference)
@apps/api/src/routes/oauth/google.ts (OAuth route pattern reference)
@apps/api/src/repositories/employee.repository.ts (employee upsert)
@packages/shared/src/types/employee.ts (Employee type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BambooHR service with OAuth and employee fetch</name>
  <files>apps/api/src/services/bamboohr.service.ts, apps/api/src/services/index.ts</files>
  <action>
Create BambooHR service following the google-calendar.service.ts pattern:

1. **OAuth Configuration:**
   - Authorization URL: `https://api.bamboohr.com/oauth/authorize`
   - Token URL: `https://api.bamboohr.com/oauth/token`
   - Required scopes: none (BambooHR grants all permissions)
   - State includes: organizationId, redirectUrl, companyDomain

2. **BambooHROAuthState interface:**
   - organizationId: string
   - redirectUrl: string
   - companyDomain: string (user's BambooHR subdomain, e.g., "acme" for acme.bamboohr.com)

3. **BambooHRExchangeResult interface:**
   - tokens: { accessToken, refreshToken, expiresAt }
   - companyDomain: string (preserved from state for API calls)

4. **Service methods:**
   - `getAuthUrl(state: string): string` - Generate OAuth authorization URL
   - `exchangeCode(code: string): Promise<BambooHRExchangeResult>` - Exchange code for tokens
   - `refreshToken(refreshToken: string): Promise<{ accessToken, expiresInMs }>` - Refresh access token
   - `fetchEmployees(companyDomain: string, accessToken: string): Promise<BambooHREmployee[]>` - Fetch employee directory

5. **BambooHREmployee interface (internal mapping):**
   ```typescript
   interface BambooHREmployee {
     id: string;
     firstName: string;
     lastName: string;
     workEmail: string;
     jobTitle: string;
     department: string;
     payRate: string;  // Numeric string like "75000" or "35.50"
     payType: 'Hourly' | 'Salary';
   }
   ```

6. **fetchEmployees implementation:**
   - GET `https://api.bamboohr.com/api/gateway.php/{companyDomain}/v1/employees/directory`
   - Headers: `Authorization: Bearer {accessToken}`, `Accept: application/json`
   - Return parsed employees array

7. Export service instance and types from index.ts

Note: BambooHR does NOT require separate scopes or consent. All API access is granted through OAuth.
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build` - should compile without errors
  </verify>
  <done>
BambooHR service exports bambooHRService with getAuthUrl, exchangeCode, refreshToken, and fetchEmployees methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HRIS sync service for employee import</name>
  <files>apps/api/src/services/hris-sync.service.ts, apps/api/src/services/index.ts</files>
  <action>
Create HRIS sync service that orchestrates employee import from any HRIS source:

1. **Hourly rate calculation function:**
   ```typescript
   function calculateHourlyRateCents(payRate: number, payType: 'Hourly' | 'Salary' | 'yearly' | 'hourly'): number {
     const isHourly = payType === 'Hourly' || payType === 'hourly';
     if (isHourly) {
       return Math.round(payRate * 100);
     }
     // Annual salary to hourly: 2080 hours/year (40 hrs/week * 52 weeks)
     return Math.round((payRate * 100) / 2080);
   }
   ```

2. **syncFromBambooHR method:**
   - Parameters: organizationId, companyDomain, accessToken
   - Calls bambooHRService.fetchEmployees()
   - For each employee:
     - Map to Employee format using employeeRepository.upsertBySourceId()
     - sourceType: 'bamboohr'
     - sourceId: BambooHR employee.id
     - email: employee.workEmail.toLowerCase()
     - name: `${employee.firstName} ${employee.lastName}`.trim()
     - role: employee.jobTitle || ''
     - department: employee.department || ''
     - hourlyRateCents: calculateHourlyRateCents(parseFloat(employee.payRate), employee.payType)
     - employmentStatus: 'fullTime' (BambooHR directory only returns active employees)
   - Return { imported: number, updated: number }

3. **triggerInitialSync method (async, non-blocking):**
   - Parameters: integrationId
   - Fetch integration from repository
   - Get decrypted credentials
   - Parse companyDomain from integration.metadata (stored during OAuth)
   - Call syncFromBambooHR()
   - Log results
   - Don't throw - log errors and continue

4. Export service instance from index.ts

Handle missing data gracefully:
- payRate missing or invalid: set hourlyRateCents to 0
- jobTitle missing: set role to empty string
- department missing: set department to empty string
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build` - should compile without errors
  </verify>
  <done>
HRIS sync service can import BambooHR employees to Firestore with hourly rate calculation and upsert logic
  </done>
</task>

<task type="auto">
  <name>Task 3: Create BambooHR OAuth routes and wire up token refresh</name>
  <files>apps/api/src/routes/oauth/bamboohr.ts, apps/api/src/routes/oauth/index.ts, apps/api/src/services/token-refresh.service.ts</files>
  <action>
Create OAuth routes following the exact pattern from apps/api/src/routes/oauth/google.ts:

1. **apps/api/src/routes/oauth/bamboohr.ts:**

   **GET /authorize** (protected with authMiddleware):
   - Query params: organizationId (required), redirectUrl (required), companyDomain (required)
   - Validate all three params exist
   - Create state object: { organizationId, redirectUrl, companyDomain }
   - Call bambooHRService.getAuthUrl(JSON.stringify(state))
   - Return { success: true, data: { url } }

   **GET /callback** (public - Google redirects here):
   - Query params: code, state, error
   - Parse state to get organizationId, redirectUrl, companyDomain
   - If error: redirect to redirectUrl with ?error={error}&provider=bamboohr
   - If missing code/state: redirect with ?error=missing_params&provider=bamboohr
   - Exchange code via bambooHRService.exchangeCode()
   - Store integration via integrationService.connect():
     - provider: 'bamboohr'
     - accountEmail: companyDomain + '@bamboohr' (BambooHR doesn't expose user email)
     - accountId: companyDomain
     - scopes: [] (BambooHR doesn't use scopes)
     - Store companyDomain in a way that can be retrieved for sync (add metadata field to integration)
   - Trigger initial sync async: hrisSyncService.triggerInitialSync(integration.id).catch(...)
   - Redirect to redirectUrl with ?success=true&provider=bamboohr

2. **Update apps/api/src/routes/oauth/index.ts:**
   - Import bambooHROAuth from './bamboohr.js'
   - Mount at route('/bamboohr', bambooHROAuth)

3. **Update apps/api/src/services/token-refresh.service.ts:**
   - Add bamboohr case to refreshProviderToken():
     ```typescript
     case 'bamboohr': {
       const result = await bambooHRService.refreshToken(credentials.refreshToken);
       return {
         accessToken: result.accessToken,
         expiresInMs: result.expiresInMs,
         refreshToken: result.refreshToken,
       };
     }
     ```

4. **Add IntegrationProvider type:**
   - Check if 'bamboohr' is already in IntegrationProvider union in shared types
   - If not, add it (in packages/shared/src/types/integration.ts)
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build` - should compile without errors. Verify routes mount correctly by checking OAuth route exports.
  </verify>
  <done>
BambooHR OAuth routes exist at /oauth/bamboohr/authorize and /oauth/bamboohr/callback, token refresh handles bamboohr provider
  </done>
</task>

</tasks>

<verification>
1. Build passes: `pnpm build` succeeds
2. BambooHR service exports: bambooHRService, BambooHRExchangeResult, BambooHROAuthState
3. HRIS sync service exports: hrisSyncService with syncFromBambooHR method
4. OAuth routes registered: /oauth/bamboohr/authorize, /oauth/bamboohr/callback
5. Token refresh handles: 'bamboohr' provider case exists
</verification>

<success_criteria>
- BambooHR OAuth service follows google-calendar.service.ts pattern
- HRIS sync service correctly calculates hourly rate from salary (divide by 2080)
- Employee data upserted with sourceType='bamboohr' and proper sourceId
- OAuth callback triggers initial sync asynchronously
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-hris-integration/06-01-SUMMARY.md`
</output>
