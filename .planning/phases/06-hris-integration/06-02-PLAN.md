---
phase: 06-hris-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/package.json
  - apps/web/package.json
  - apps/api/src/services/finch.service.ts
  - apps/api/src/services/hris-sync.service.ts
  - apps/api/src/routes/oauth/finch.ts
  - apps/api/src/routes/oauth/index.ts
  - apps/api/src/services/index.ts
  - apps/api/src/services/token-refresh.service.ts
autonomous: true
requirements: [HRIS-02, HRIS-03, HRIS-05, HRIS-06]

must_haves:
  truths:
    - "User can connect Rippling via Finch unified API"
    - "User can connect Gusto via Finch unified API"
    - "System imports employees with name, email, role, department, hourly rate"
    - "System calculates hourly rate from annual salary when hourly not provided"
  artifacts:
    - path: "apps/api/src/services/finch.service.ts"
      provides: "Finch Connect session and employee fetch"
      exports: ["finchService", "FinchExchangeResult"]
    - path: "apps/api/src/routes/oauth/finch.ts"
      provides: "Finch OAuth routes"
      exports: ["finchOAuth"]
  key_links:
    - from: "apps/api/src/routes/oauth/finch.ts"
      to: "apps/api/src/services/finch.service.ts"
      via: "service import"
      pattern: "finchService\\."
    - from: "apps/api/src/services/hris-sync.service.ts"
      to: "apps/api/src/services/finch.service.ts"
      via: "Finch employee fetch"
      pattern: "finchService\\.fetchEmployees"

user_setup:
  - service: finch
    why: "Unified HRIS API for Rippling/Gusto employee data"
    env_vars:
      - name: FINCH_CLIENT_ID
        source: "Finch Dashboard -> Developers -> Applications"
      - name: FINCH_CLIENT_SECRET
        source: "Finch Dashboard -> Developers -> Applications"
      - name: FINCH_SANDBOX
        source: "Set to 'true' for development, 'false' for production"
    dashboard_config:
      - task: "Create Finch application"
        location: "https://dashboard.tryfinch.com"
      - task: "Configure redirect URI"
        location: "Finch Dashboard -> Application Settings -> Redirect URIs"
---

<objective>
Finch unified API integration enabling users to connect Rippling and Gusto HR systems.

Purpose: Finch provides a unified API across 275+ HRIS providers. We use it specifically for Rippling and Gusto since direct API access requires partner approval (4-12 weeks). This enables immediate MVP launch while partner applications are pending.

Output: Finch service with Connect session flow, OAuth callback handling, and employee sync that maps Finch's unified data model to our Employee schema.
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-hris-integration/06-RESEARCH.md
@apps/api/src/services/google-calendar.service.ts (OAuth pattern reference)
@apps/api/src/services/bamboohr.service.ts (HRIS service pattern - if created in 06-01)
@apps/api/src/repositories/employee.repository.ts (employee upsert)
@packages/shared/src/types/employee.ts (Employee type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Finch SDKs</name>
  <files>apps/api/package.json, apps/web/package.json</files>
  <action>
Install Finch packages:

1. **API package (backend SDK):**
   ```bash
   cd apps/api && pnpm add @tryfinch/finch-api
   ```

2. **Web package (React Connect SDK):**
   ```bash
   cd apps/web && pnpm add @tryfinch/react-connect
   ```

Note: react-papaparse is already planned for Plan 03 (CSV processing).
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm install && pnpm build` - packages should install and build successfully
  </verify>
  <done>
@tryfinch/finch-api in apps/api, @tryfinch/react-connect in apps/web
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Finch service with Connect session and employee fetch</name>
  <files>apps/api/src/services/finch.service.ts, apps/api/src/services/index.ts</files>
  <action>
Create Finch service for unified HRIS access:

1. **Import Finch SDK:**
   ```typescript
   import Finch from '@tryfinch/finch-api';
   ```

2. **FinchConnectSession interface:**
   ```typescript
   interface FinchConnectSession {
     sessionId: string;
     connectUrl: string;
   }
   ```

3. **FinchExchangeResult interface:**
   ```typescript
   interface FinchExchangeResult {
     accessToken: string;
     providerId: string;  // e.g., 'gusto', 'rippling'
     companyId: string;
     companyName: string;
   }
   ```

4. **Service methods:**

   a. `createConnectSession(organizationId: string, organizationName: string): Promise<FinchConnectSession>`
      - Create Finch client with client ID/secret from env
      - Call finch.connect.sessions.create() with:
        - customerId: organizationId
        - customerName: organizationName
        - products: ['company', 'directory', 'individual', 'employment']
        - sandbox: process.env.FINCH_SANDBOX === 'true'
      - Return { sessionId, connectUrl }

   b. `exchangeCode(code: string): Promise<FinchExchangeResult>`
      - Call token exchange endpoint:
        POST https://api.tryfinch.com/auth/token
        with client_id, client_secret, code, grant_type: 'authorization_code'
      - Get access token from response
      - Create Finch client with access token
      - Fetch company info: finch.hris.company.retrieve()
      - Return { accessToken, providerId, companyId, companyName }

   c. `fetchEmployees(accessToken: string): Promise<FinchEmployee[]>`
      - Create Finch client with accessToken
      - Use directory list with auto-pagination:
        ```typescript
        const employees: FinchEmployee[] = [];
        for await (const individual of finch.hris.directory.list()) {
          // Fetch detailed employment info
          const employmentResp = await finch.hris.employment.retrieveMany({
            requests: [{ individual_id: individual.id }]
          });
          const employment = employmentResp.responses[0]?.body;

          // Fetch individual details
          const individualResp = await finch.hris.individual.retrieveMany({
            requests: [{ individual_id: individual.id }]
          });
          const details = individualResp.responses[0]?.body;

          employees.push({
            id: individual.id,
            firstName: details?.first_name || '',
            lastName: details?.last_name || '',
            workEmail: details?.emails?.find(e => e.type === 'work')?.data || '',
            jobTitle: employment?.title || '',
            department: employment?.department?.name || '',
            income: employment?.income,  // { amount, currency, unit: 'yearly'|'hourly' }
            isActive: individual.is_active,
          });
        }
        return employees;
        ```

5. **FinchEmployee interface:**
   ```typescript
   interface FinchEmployee {
     id: string;
     firstName: string;
     lastName: string;
     workEmail: string;
     jobTitle: string;
     department: string;
     income: { amount: number; currency: string; unit: 'yearly' | 'hourly' } | null;
     isActive: boolean;
   }
   ```

6. Export finchService and types from services/index.ts

Handle rate limits with exponential backoff if needed (Finch auto-paginates internally).
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build` - should compile without errors
  </verify>
  <done>
Finch service exports finchService with createConnectSession, exchangeCode, and fetchEmployees methods
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Finch sync method to HRIS sync service and create OAuth routes</name>
  <files>apps/api/src/services/hris-sync.service.ts, apps/api/src/routes/oauth/finch.ts, apps/api/src/routes/oauth/index.ts, apps/api/src/services/token-refresh.service.ts</files>
  <action>
1. **Update apps/api/src/services/hris-sync.service.ts:**

   Add `syncFromFinch` method:
   ```typescript
   async syncFromFinch(organizationId: string, accessToken: string): Promise<{ imported: number; updated: number }> {
     const employees = await finchService.fetchEmployees(accessToken);
     let imported = 0;
     let updated = 0;

     for (const emp of employees) {
       // Skip inactive employees
       if (!emp.isActive) continue;

       // Calculate hourly rate
       let hourlyRateCents = 0;
       if (emp.income) {
         const isHourly = emp.income.unit === 'hourly';
         if (isHourly) {
           hourlyRateCents = Math.round(emp.income.amount * 100);
         } else {
           // Annual to hourly: 2080 hours/year
           hourlyRateCents = Math.round((emp.income.amount * 100) / 2080);
         }
       }

       const existing = await employeeRepository.findBySourceId(organizationId, 'finch', emp.id);

       await employeeRepository.upsertBySourceId(
         organizationId,
         'finch',
         emp.id,
         {
           name: `${emp.firstName} ${emp.lastName}`.trim(),
           email: emp.workEmail.toLowerCase(),
           role: emp.jobTitle,
           department: emp.department,
           hourlyRateCents,
           employmentStatus: 'fullTime',
         }
       );

       if (existing) updated++;
       else imported++;
     }

     return { imported, updated };
   }
   ```

   Update `triggerInitialSync` to handle 'finch' provider based on integration.provider field.

2. **Create apps/api/src/routes/oauth/finch.ts:**

   **POST /session** (protected with authMiddleware):
   - Body: { organizationId, organizationName }
   - Validate organizationId and organizationName exist
   - Call finchService.createConnectSession()
   - Return { success: true, data: { sessionId, connectUrl } }

   **POST /callback** (protected with authMiddleware):
   - Body: { code, organizationId, redirectUrl }
   - Exchange code via finchService.exchangeCode()
   - Store integration via integrationService.connect():
     - provider: 'finch'
     - accountEmail: companyName + '@' + providerId (e.g., "Acme Corp@gusto")
     - accountId: companyId
     - scopes: ['company', 'directory', 'individual', 'employment']
     - accessToken from Finch (Finch doesn't use refresh tokens - tokens are long-lived)
     - refreshToken: '' (empty - Finch tokens don't expire)
     - expiresAt: far future date (Finch tokens are persistent until disconnected)
   - Trigger initial sync async: hrisSyncService.triggerInitialSync(integration.id).catch(...)
   - Return { success: true, data: { integrationId: integration.id, providerId, companyName } }

3. **Update apps/api/src/routes/oauth/index.ts:**
   - Import finchOAuth from './finch.js'
   - Mount at route('/finch', finchOAuth)

4. **Update apps/api/src/services/token-refresh.service.ts:**
   - Add 'finch' case that does nothing (Finch tokens don't expire):
     ```typescript
     case 'finch': {
       // Finch tokens are persistent and don't expire
       // If we get here, the connection is likely invalid - mark as error
       throw new Error('Finch tokens do not require refresh - connection may be invalid');
     }
     ```

Note: Finch uses Connect sessions instead of traditional OAuth redirects. Frontend calls POST /session, then uses the sessionId with @tryfinch/react-connect to show the embedded auth modal.
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build` - should compile without errors
  </verify>
  <done>
Finch OAuth routes exist at /oauth/finch/session and /oauth/finch/callback, HRIS sync service handles Finch employee import
  </done>
</task>

</tasks>

<verification>
1. Build passes: `pnpm build` succeeds
2. Finch packages installed: @tryfinch/finch-api in api, @tryfinch/react-connect in web
3. Finch service exports: finchService with createConnectSession, exchangeCode, fetchEmployees
4. HRIS sync handles Finch: syncFromFinch method exists
5. OAuth routes registered: /oauth/finch/session (POST), /oauth/finch/callback (POST)
</verification>

<success_criteria>
- Finch SDK installed and importable
- Finch service creates Connect sessions for embedded auth
- Employee sync maps Finch unified model to our Employee schema
- Hourly rate calculated correctly from annual salary
- Integration stored with provider='finch' after successful auth
</success_criteria>

<output>
After completion, create `.planning/phases/06-hris-integration/06-02-SUMMARY.md`
</output>
