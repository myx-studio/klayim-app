---
phase: 06-hris-integration
plan: 03
type: execute
wave: 2
depends_on: [06-01, 06-02]
files_modified:
  - apps/web/package.json
  - apps/api/src/routes/employees.ts
  - apps/api/src/routes/index.ts
  - apps/web/src/lib/api/hris.ts
  - apps/web/src/lib/api/employees.ts
  - apps/web/src/components/pages/onboarding/connect-hris/index.tsx
  - apps/web/src/components/pages/onboarding/upload-csv/index.tsx
  - apps/web/src/components/pages/onboarding/upload-csv/validate.tsx
  - apps/web/src/components/pages/onboarding/upload-csv/confirm.tsx
  - packages/shared/src/schemas/employee.schema.ts
autonomous: true
requirements: [HRIS-04, HRIS-05, HRIS-06, HRIS-07]

must_haves:
  truths:
    - "User can upload CSV file and see parsed employees"
    - "System validates CSV rows against schema"
    - "System calculates hourly rate from annual salary if needed"
    - "User can import validated employees to database"
    - "Connect HRIS page triggers OAuth flows for BambooHR/Rippling/Gusto"
    - "User sees what data will be imported before connecting"
  artifacts:
    - path: "apps/api/src/routes/employees.ts"
      provides: "Employee import API endpoint"
      exports: ["employeeRoutes"]
    - path: "apps/web/src/lib/api/hris.ts"
      provides: "HRIS API client functions"
      exports: ["getBambooHRAuthUrl", "createFinchSession", "exchangeFinchCode"]
    - path: "apps/web/src/lib/api/employees.ts"
      provides: "Employee API client functions"
      exports: ["importEmployees", "getEmployees"]
  key_links:
    - from: "apps/web/src/components/pages/onboarding/upload-csv/confirm.tsx"
      to: "apps/api/src/routes/employees.ts"
      via: "fetch POST /employees/import"
      pattern: "importEmployees\\("
    - from: "apps/web/src/components/pages/onboarding/connect-hris/index.tsx"
      to: "apps/web/src/lib/api/hris.ts"
      via: "API client import"
      pattern: "getBambooHRAuthUrl|createFinchSession"
---

<objective>
CSV processing and frontend wiring enabling complete HRIS data import flow.

Purpose: Users who don't have BambooHR/Rippling/Gusto can upload a CSV file with employee data. Also wires up the connect-hris page to actually call the OAuth endpoints created in Plans 01 and 02.

Output: Working CSV upload flow (parse with PapaParse, validate, preview, import), employee import API, and frontend handlers that initiate HRIS OAuth flows.
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-hris-integration/06-RESEARCH.md
@.planning/phases/06-hris-integration/06-01-SUMMARY.md
@.planning/phases/06-hris-integration/06-02-SUMMARY.md
@apps/web/src/components/pages/onboarding/upload-csv/index.tsx (existing file selection)
@apps/web/src/components/pages/onboarding/upload-csv/validate.tsx (mock validation)
@apps/web/src/components/pages/onboarding/upload-csv/confirm.tsx (mock data)
@apps/web/src/components/pages/onboarding/connect-hris/index.tsx (placeholder handlers)
@apps/web/src/lib/api/integrations.ts (API client pattern)
@packages/shared/src/schemas/employee.schema.ts (CSV schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-papaparse and create employee import API</name>
  <files>apps/web/package.json, apps/api/src/routes/employees.ts, apps/api/src/routes/index.ts</files>
  <action>
1. **Install react-papaparse:**
   ```bash
   cd apps/web && pnpm add react-papaparse
   ```

2. **Create apps/api/src/routes/employees.ts:**

   **POST /import** (protected with authMiddleware):
   - Body: { organizationId, employees: CsvEmployeeRow[] }
   - Validate organizationId exists
   - For each employee in array:
     - Validate with csvEmployeeRowSchema
     - Calculate hourlyRateCents:
       ```typescript
       const hourlyRateCents = employee.hourlyRate
         ? Math.round(employee.hourlyRate * 100)
         : employee.annualSalary
         ? Math.round((employee.annualSalary * 100) / 2080)
         : 0;
       ```
     - Upsert via employeeRepository.upsertBySourceId() with:
       - sourceType: 'csv'
       - sourceId: generate deterministic ID from email: `csv_${hash(email)}`
       - name, email, role, department from CSV
       - hourlyRateCents calculated above
       - employmentStatus: 'fullTime'
   - Return { success: true, data: { imported: number, updated: number } }

   **GET /** (protected with authMiddleware):
   - Query param: organizationId
   - Return all employees for organization via employeeRepository.findByOrganization()
   - Return { success: true, data: Employee[] }

3. **Update apps/api/src/routes/index.ts:**
   - Import employeeRoutes from './employees.js'
   - Mount at api.route('/employees', employeeRoutes)

Note: For CSV imports, use email as the stable identifier. Generate a deterministic sourceId from email to allow re-imports to update existing records.
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm install && pnpm build` - should compile without errors
  </verify>
  <done>
Employee import API at POST /employees/import accepts array of CSV rows and upserts to Firestore
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HRIS and Employee API client functions</name>
  <files>apps/web/src/lib/api/hris.ts, apps/web/src/lib/api/employees.ts</files>
  <action>
1. **Create apps/web/src/lib/api/hris.ts:**

   Following the pattern from integrations.ts:

   ```typescript
   import { fetcher } from "@/lib/fetcher";
   import type { ApiResponse } from "@klayim/shared";

   /**
    * Get BambooHR OAuth authorization URL
    */
   export async function getBambooHRAuthUrl(
     organizationId: string,
     redirectUrl: string,
     companyDomain: string
   ): Promise<{ url: string }> {
     const response = await fetcher<ApiResponse<{ url: string }>>(
       "/oauth/bamboohr/authorize",
       {
         params: { organizationId, redirectUrl, companyDomain },
       }
     );
     if (!response.success || !response.data) {
       throw new Error(response.error || "Failed to get BambooHR authorization URL");
     }
     return response.data;
   }

   /**
    * Create Finch Connect session for Rippling/Gusto
    */
   export async function createFinchSession(
     organizationId: string,
     organizationName: string
   ): Promise<{ sessionId: string; connectUrl: string }> {
     const response = await fetcher<ApiResponse<{ sessionId: string; connectUrl: string }>>(
       "/oauth/finch/session",
       {
         method: "POST",
         body: JSON.stringify({ organizationId, organizationName }),
       }
     );
     if (!response.success || !response.data) {
       throw new Error(response.error || "Failed to create Finch session");
     }
     return response.data;
   }

   /**
    * Exchange Finch authorization code for access token
    */
   export async function exchangeFinchCode(
     code: string,
     organizationId: string
   ): Promise<{ integrationId: string; providerId: string; companyName: string }> {
     const response = await fetcher<ApiResponse<{ integrationId: string; providerId: string; companyName: string }>>(
       "/oauth/finch/callback",
       {
         method: "POST",
         body: JSON.stringify({ code, organizationId }),
       }
     );
     if (!response.success || !response.data) {
       throw new Error(response.error || "Failed to exchange Finch code");
     }
     return response.data;
   }
   ```

2. **Create apps/web/src/lib/api/employees.ts:**

   ```typescript
   import { fetcher } from "@/lib/fetcher";
   import type { ApiResponse, Employee, CsvEmployeeRow } from "@klayim/shared";

   /**
    * Import employees from CSV data
    */
   export async function importEmployees(
     organizationId: string,
     employees: CsvEmployeeRow[]
   ): Promise<{ imported: number; updated: number }> {
     const response = await fetcher<ApiResponse<{ imported: number; updated: number }>>(
       "/employees/import",
       {
         method: "POST",
         body: JSON.stringify({ organizationId, employees }),
       }
     );
     if (!response.success || !response.data) {
       throw new Error(response.error || "Failed to import employees");
     }
     return response.data;
   }

   /**
    * Get all employees for an organization
    */
   export async function getEmployees(organizationId: string): Promise<Employee[]> {
     const response = await fetcher<ApiResponse<Employee[]>>(
       "/employees",
       {
         params: { organizationId },
       }
     );
     if (!response.success) {
       throw new Error(response.error || "Failed to get employees");
     }
     return response.data || [];
   }
   ```
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build` - should compile without errors
  </verify>
  <done>
HRIS and Employee API clients export functions for OAuth and employee import
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up connect-hris page with real OAuth handlers</name>
  <files>apps/web/src/components/pages/onboarding/connect-hris/index.tsx</files>
  <action>
Update connect-hris page to call actual OAuth endpoints:

1. **Add state for BambooHR domain input:**
   - useState for showBambooHRDialog (boolean)
   - useState for bambooHRDomain (string)
   - Dialog component to collect company domain before OAuth

2. **Update handleConnectBambooHR:**
   ```typescript
   const handleConnectBambooHR = async () => {
     if (!bambooHRDomain) {
       setShowBambooHRDialog(true);
       return;
     }
     try {
       setIsLoading(true);
       const { url } = await getBambooHRAuthUrl(
         organizationId, // Get from context/session
         window.location.href,
         bambooHRDomain
       );
       window.location.href = url;
     } catch (error) {
       toast.error(error instanceof Error ? error.message : 'Failed to connect BambooHR');
     } finally {
       setIsLoading(false);
     }
   };
   ```

3. **Add BambooHR domain dialog:**
   - Use Dialog component from ui/dialog
   - Input for company subdomain (e.g., "acme" for acme.bamboohr.com)
   - Helper text: "Enter your BambooHR subdomain (the part before .bamboohr.com)"
   - Connect button that calls handleConnectBambooHR with domain set

4. **Update handleConnectRippling and handleConnectGusto to use Finch:**
   ```typescript
   const handleConnectWithFinch = async () => {
     try {
       setIsLoading(true);
       const { sessionId } = await createFinchSession(organizationId, organizationName);
       // Finch Connect will be opened by the useFinchConnect hook
       openFinchConnect(sessionId);
     } catch (error) {
       toast.error(error instanceof Error ? error.message : 'Failed to connect');
     } finally {
       setIsLoading(false);
     }
   };
   ```

5. **Add Finch Connect hook:**
   ```typescript
   import { useFinchConnect } from '@tryfinch/react-connect';

   const { open: openFinchConnect } = useFinchConnect({
     onSuccess: async ({ code }) => {
       try {
         const result = await exchangeFinchCode(code, organizationId);
         toast.success(`Connected to ${result.companyName}`);
         router.push('/onboarding/connect-calendar');
       } catch (error) {
         toast.error('Failed to complete connection');
       }
     },
     onError: ({ errorMessage }) => {
       toast.error(errorMessage);
     },
     onClose: () => {
       setIsLoading(false);
     },
   });
   ```

6. **Handle OAuth callback URL params:**
   - Check for ?success=true&provider=bamboohr on mount
   - Show success toast if present
   - Check for ?error= and show error toast

7. **Get organizationId from session/context:**
   - Use existing auth context to get current user's organizationId
   - If not available, redirect to login

Note: Rippling and Gusto both use the same Finch handler - the user selects their provider inside the Finch Connect modal.
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build` - should compile without errors
  </verify>
  <done>
Connect HRIS page shows BambooHR domain dialog and uses Finch Connect for Rippling/Gusto
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement CSV parsing and validation flow</name>
  <files>apps/web/src/components/pages/onboarding/upload-csv/index.tsx, apps/web/src/components/pages/onboarding/upload-csv/validate.tsx, apps/web/src/components/pages/onboarding/upload-csv/confirm.tsx, packages/shared/src/schemas/employee.schema.ts</files>
  <action>
1. **Update packages/shared/src/schemas/employee.schema.ts:**

   Add column name normalization helper:
   ```typescript
   // Mapping of common CSV column variations to our field names
   export const csvColumnAliases: Record<string, string> = {
     'full_name': 'name',
     'employee_name': 'name',
     'fullname': 'name',
     'email_address': 'email',
     'work_email': 'email',
     'email address': 'email',
     'job_title': 'role',
     'title': 'role',
     'position': 'role',
     'annual_salary': 'annualSalary',
     'yearly_salary': 'annualSalary',
     'salary': 'annualSalary',
     'hourly_rate': 'hourlyRate',
     'rate': 'hourlyRate',
     'hourly': 'hourlyRate',
   };
   ```

2. **Update apps/web/src/components/pages/onboarding/upload-csv/index.tsx:**

   Store file in sessionStorage for next pages:
   ```typescript
   const handleNext = async () => {
     if (!selectedFile) return;
     // Read file content and store for next page
     const content = await selectedFile.text();
     sessionStorage.setItem('csvUpload', JSON.stringify({
       name: selectedFile.name,
       content,
     }));
     router.push("/onboarding/upload-csv/validate");
   };
   ```

3. **Update apps/web/src/components/pages/onboarding/upload-csv/validate.tsx:**

   Replace mock validation with real parsing:
   ```typescript
   import Papa from 'papaparse';
   import { csvEmployeeRowSchema, csvColumnAliases } from '@klayim/shared';

   // State
   const [validationSteps, setValidationSteps] = useState<ValidationStep[]>([...]);
   const [parseResult, setParseResult] = useState<{ valid: CsvEmployeeRow[]; errors: Error[] } | null>(null);

   useEffect(() => {
     const stored = sessionStorage.getItem('csvUpload');
     if (!stored) {
       router.push('/onboarding/upload-csv');
       return;
     }

     const { content } = JSON.parse(stored);

     // Step 1: Parse CSV
     setStepLoading('format');
     Papa.parse(content, {
       header: true,
       skipEmptyLines: true,
       complete: (results) => {
         setStepCompleted('format');

         // Step 2: Validate emails
         setStepLoading('emails');
         const normalized = results.data.map(normalizeRow);
         const validationResults = validateRows(normalized);
         setStepCompleted('emails');

         // Step 3: Calculate rates
         setStepLoading('rates');
         // Rate calculation happens during import, just validate presence
         setStepCompleted('rates');

         setParseResult(validationResults);
         sessionStorage.setItem('csvValidated', JSON.stringify(validationResults.valid));
         router.push('/onboarding/upload-csv/confirm');
       },
     });
   }, []);

   function normalizeRow(row: Record<string, string>): Record<string, unknown> {
     const normalized: Record<string, unknown> = {};
     Object.entries(row).forEach(([key, value]) => {
       const lowerKey = key.toLowerCase().trim().replace(/\s+/g, '_');
       const mappedKey = csvColumnAliases[lowerKey] || lowerKey;
       if (['hourlyRate', 'annualSalary'].includes(mappedKey)) {
         normalized[mappedKey] = parseFloat(value) || undefined;
       } else {
         normalized[mappedKey] = value;
       }
     });
     return normalized;
   }

   function validateRows(rows: Record<string, unknown>[]): { valid: CsvEmployeeRow[]; errors: Error[] } {
     const valid: CsvEmployeeRow[] = [];
     const errors: Error[] = [];
     rows.forEach((row, index) => {
       const result = csvEmployeeRowSchema.safeParse(row);
       if (result.success) {
         valid.push(result.data);
       } else {
         errors.push({
           row: index + 2,
           issues: result.error.issues,
         });
       }
     });
     return { valid, errors };
   }
   ```

4. **Update apps/web/src/components/pages/onboarding/upload-csv/confirm.tsx:**

   Replace mock data with real validated data:
   ```typescript
   import { importEmployees } from '@/lib/api/employees';
   import type { CsvEmployeeRow } from '@klayim/shared';

   const [employees, setEmployees] = useState<CsvEmployeeRow[]>([]);
   const [isImporting, setIsImporting] = useState(false);

   useEffect(() => {
     const stored = sessionStorage.getItem('csvValidated');
     if (!stored) {
       router.push('/onboarding/upload-csv');
       return;
     }
     setEmployees(JSON.parse(stored));
   }, []);

   const handleImport = async () => {
     try {
       setIsImporting(true);
       const result = await importEmployees(organizationId, employees);
       toast.success(`Imported ${result.imported} employees, updated ${result.updated}`);
       // Clear session storage
       sessionStorage.removeItem('csvUpload');
       sessionStorage.removeItem('csvValidated');
       router.push('/onboarding/connect-calendar');
     } catch (error) {
       toast.error(error instanceof Error ? error.message : 'Failed to import employees');
     } finally {
       setIsImporting(false);
     }
   };

   // Calculate hourly rate for display (same formula as backend)
   const getHourlyRate = (emp: CsvEmployeeRow) => {
     if (emp.hourlyRate) return emp.hourlyRate;
     if (emp.annualSalary) return Math.round((emp.annualSalary / 2080) * 100) / 100;
     return 0;
   };
   ```

   Update table to display actual parsed data instead of mockEmployees.
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build` - should compile without errors
  </verify>
  <done>
CSV upload flow parses with PapaParse, validates against schema, previews data, and imports to database
  </done>
</task>

</tasks>

<verification>
1. Build passes: `pnpm build` succeeds
2. Employee import API: POST /employees/import accepts CsvEmployeeRow[]
3. CSV parsing works: File parsed with PapaParse, columns normalized
4. Validation works: Invalid rows identified with error messages
5. BambooHR connect: Shows domain dialog, then redirects to OAuth
6. Finch connect: Opens Finch Connect modal for Rippling/Gusto
7. Import works: Validated employees saved to Firestore
</verification>

<success_criteria>
- CSV file is parsed client-side with PapaParse
- Column names are normalized (handles common variations)
- Invalid rows show clear error messages
- Valid employees displayed in preview table with calculated hourly rates
- Import button saves employees to Firestore via API
- Connect HRIS page initiates real OAuth flows
- OAuth callback shows success/error toast notifications
</success_criteria>

<output>
After completion, create `.planning/phases/06-hris-integration/06-03-SUMMARY.md`
</output>
