---
phase: 02-plan-billing
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - apps/web/src/app/onboarding/plan-selection/page.tsx
  - apps/web/src/components/pages/onboarding/plan-selection/index.tsx
  - apps/web/src/components/pages/onboarding/plan-selection/plan-card.tsx
  - apps/web/src/components/pages/onboarding/plan-selection/enterprise-form.tsx
  - apps/web/src/hooks/use-billing.ts
  - apps/web/src/lib/api/billing.ts
autonomous: true
requirements: [BILL-01, BILL-03]

must_haves:
  truths:
    - "User sees three pricing cards (Individual $49, Team $149, Enterprise custom)"
    - "User can click Individual or Team to initiate Stripe Checkout"
    - "User can click Enterprise to see contact sales form"
    - "Enterprise form submits successfully and shows confirmation"
  artifacts:
    - path: "apps/web/src/app/onboarding/plan-selection/page.tsx"
      provides: "Plan selection page route"
      min_lines: 5
    - path: "apps/web/src/components/pages/onboarding/plan-selection/index.tsx"
      provides: "Plan selection page component"
      min_lines: 50
    - path: "apps/web/src/components/pages/onboarding/plan-selection/plan-card.tsx"
      provides: "Individual plan card component"
      min_lines: 30
    - path: "apps/web/src/components/pages/onboarding/plan-selection/enterprise-form.tsx"
      provides: "Enterprise contact form"
      min_lines: 40
    - path: "apps/web/src/hooks/use-billing.ts"
      provides: "Billing hooks for checkout and contact"
      exports: ["useCreateCheckoutSession", "useContactSales"]
  key_links:
    - from: "apps/web/src/components/pages/onboarding/plan-selection/index.tsx"
      to: "apps/web/src/hooks/use-billing.ts"
      via: "hook usage"
      pattern: "useCreateCheckoutSession"
    - from: "apps/web/src/hooks/use-billing.ts"
      to: "/billing/checkout"
      via: "API call"
      pattern: "fetcher.*billing/checkout"
---

<objective>
Create plan selection UI with pricing cards and enterprise contact form

Purpose: Allow users to view plan options and initiate subscription or contact sales
Output: Plan selection page with three pricing tiers and enterprise contact form
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plan-billing/02-RESEARCH.md
@.planning/phases/02-plan-billing/02-01-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Billing Hooks and API Client</name>
  <files>
    apps/web/src/lib/api/billing.ts
    apps/web/src/hooks/use-billing.ts
  </files>
  <action>
Create API client functions in `apps/web/src/lib/api/billing.ts`:

```typescript
import { fetcher } from '@/lib/fetcher';
import type { ApiResponse, CheckoutSessionResponse } from '@klayim/shared/types';
import type { CreateCheckoutSessionInput, ContactSalesInput } from '@klayim/shared/schemas';

export async function createCheckoutSession(
  input: CreateCheckoutSessionInput
): Promise<CheckoutSessionResponse> {
  const response = await fetcher<ApiResponse<CheckoutSessionResponse>>('/billing/checkout', {
    method: 'POST',
    body: JSON.stringify(input),
  });

  if (!response.success || !response.data) {
    throw new Error(response.error || 'Failed to create checkout session');
  }

  return response.data;
}

export async function contactSales(input: ContactSalesInput): Promise<void> {
  const response = await fetcher<ApiResponse<null>>('/billing/contact-sales', {
    method: 'POST',
    body: JSON.stringify(input),
  });

  if (!response.success) {
    throw new Error(response.error || 'Failed to submit contact request');
  }
}
```

Create billing hooks in `apps/web/src/hooks/use-billing.ts`:

```typescript
import { useMutation } from '@tanstack/react-query';
import { createCheckoutSession, contactSales } from '@/lib/api/billing';
import type { CreateCheckoutSessionInput, ContactSalesInput } from '@klayim/shared/schemas';

export function useCreateCheckoutSession() {
  return useMutation({
    mutationFn: (input: CreateCheckoutSessionInput) => createCheckoutSession(input),
  });
}

export function useContactSales() {
  return useMutation({
    mutationFn: (input: ContactSalesInput) => contactSales(input),
  });
}
```
  </action>
  <verify>
Check files exist and export the expected functions/hooks.
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim/apps/web && pnpm tsc --noEmit` to verify types.
  </verify>
  <done>
Billing API client and React Query hooks created.
useCreateCheckoutSession and useContactSales hooks available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Plan Card Component</name>
  <files>
    apps/web/src/components/pages/onboarding/plan-selection/plan-card.tsx
  </files>
  <action>
Create plan card component in `apps/web/src/components/pages/onboarding/plan-selection/plan-card.tsx`:

```typescript
'use client';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { Check } from 'lucide-react';
import { cn } from '@/lib/utils';

interface PlanCardProps {
  name: string;
  priceLabel: string;
  description: string;
  features: string[];
  cta: string;
  popular?: boolean;
  onSelect: () => void;
  loading?: boolean;
  disabled?: boolean;
}

export function PlanCard({
  name,
  priceLabel,
  description,
  features,
  cta,
  popular,
  onSelect,
  loading,
  disabled,
}: PlanCardProps) {
  return (
    <Card
      className={cn(
        'relative flex flex-col',
        popular && 'border-primary shadow-lg'
      )}
    >
      {popular && (
        <div className="absolute -top-3 left-1/2 -translate-x-1/2">
          <span className="bg-primary text-primary-foreground text-xs font-medium px-3 py-1 rounded-full">
            Most Popular
          </span>
        </div>
      )}
      <CardHeader className="text-center pb-2">
        <CardTitle className="text-xl">{name}</CardTitle>
        <div className="mt-2">
          <span className="text-4xl font-bold">{priceLabel}</span>
          {priceLabel !== 'Custom' && (
            <span className="text-muted-foreground">/month</span>
          )}
        </div>
        <CardDescription className="mt-2">{description}</CardDescription>
      </CardHeader>
      <CardContent className="flex-1">
        <ul className="space-y-3">
          {features.map((feature) => (
            <li key={feature} className="flex items-start gap-2">
              <Check className="h-4 w-4 text-primary mt-0.5 shrink-0" />
              <span className="text-sm">{feature}</span>
            </li>
          ))}
        </ul>
      </CardContent>
      <CardFooter>
        <Button
          onClick={onSelect}
          disabled={loading || disabled}
          className="w-full"
          variant={popular ? 'default' : 'outline'}
        >
          {loading ? 'Processing...' : cta}
        </Button>
      </CardFooter>
    </Card>
  );
}
```

Ensure the directory exists: `apps/web/src/components/pages/onboarding/plan-selection/`
  </action>
  <verify>
Check file exists at apps/web/src/components/pages/onboarding/plan-selection/plan-card.tsx.
Verify Card, Button components are imported from existing shadcn/ui.
  </verify>
  <done>
PlanCard component created with props for name, price, features, and selection callback.
Supports popular badge and loading state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Plan Selection Page and Enterprise Form</name>
  <files>
    apps/web/src/components/pages/onboarding/plan-selection/enterprise-form.tsx
    apps/web/src/components/pages/onboarding/plan-selection/index.tsx
    apps/web/src/app/onboarding/plan-selection/page.tsx
  </files>
  <action>
Create enterprise contact form in `apps/web/src/components/pages/onboarding/plan-selection/enterprise-form.tsx`:

```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { contactSalesSchema, type ContactSalesInput } from '@klayim/shared/schemas';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { ArrowLeft, CheckCircle } from 'lucide-react';
import { useContactSales } from '@/hooks/use-billing';
import { useState } from 'react';

interface EnterpriseFormProps {
  organizationId: string;
  onBack: () => void;
}

export function EnterpriseForm({ organizationId, onBack }: EnterpriseFormProps) {
  const [submitted, setSubmitted] = useState(false);
  const contactSales = useContactSales();

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<ContactSalesInput>({
    resolver: zodResolver(contactSalesSchema),
    defaultValues: {
      organizationId,
    },
  });

  const onSubmit = async (data: ContactSalesInput) => {
    await contactSales.mutateAsync(data);
    setSubmitted(true);
  };

  if (submitted) {
    return (
      <Card className="max-w-md mx-auto">
        <CardContent className="pt-6 text-center">
          <CheckCircle className="h-12 w-12 text-green-500 mx-auto mb-4" />
          <h2 className="text-xl font-semibold mb-2">Thank you!</h2>
          <p className="text-muted-foreground mb-4">
            Our sales team will be in touch within 24 hours.
          </p>
          <Button variant="outline" onClick={onBack}>
            Back to plans
          </Button>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="max-w-md mx-auto">
      <CardHeader>
        <Button
          variant="ghost"
          size="sm"
          onClick={onBack}
          className="w-fit -ml-2 mb-2"
        >
          <ArrowLeft className="h-4 w-4 mr-2" />
          Back to plans
        </Button>
        <CardTitle>Contact Sales</CardTitle>
        <CardDescription>
          Tell us about your organization and we'll get back to you within 24 hours.
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <input type="hidden" {...register('organizationId')} />

          <div className="space-y-2">
            <Label htmlFor="name">Your Name</Label>
            <Input
              id="name"
              {...register('name')}
              placeholder="John Doe"
            />
            {errors.name && (
              <p className="text-sm text-destructive">{errors.name.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="email">Work Email</Label>
            <Input
              id="email"
              type="email"
              {...register('email')}
              placeholder="john@company.com"
            />
            {errors.email && (
              <p className="text-sm text-destructive">{errors.email.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="company">Company Name</Label>
            <Input
              id="company"
              {...register('company')}
              placeholder="Acme Inc."
            />
            {errors.company && (
              <p className="text-sm text-destructive">{errors.company.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="message">Message (optional)</Label>
            <Textarea
              id="message"
              {...register('message')}
              placeholder="Tell us about your needs..."
              rows={3}
            />
          </div>

          <Button
            type="submit"
            className="w-full"
            disabled={contactSales.isPending}
          >
            {contactSales.isPending ? 'Submitting...' : 'Submit Request'}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
```

Create main plan selection page component in `apps/web/src/components/pages/onboarding/plan-selection/index.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { PlanCard } from './plan-card';
import { EnterpriseForm } from './enterprise-form';
import { useCreateCheckoutSession } from '@/hooks/use-billing';
import { useSession } from 'next-auth/react';

const PLANS = [
  {
    id: 'individual',
    name: 'Individual',
    priceLabel: '$49',
    description: 'Perfect for freelancers and solo consultants',
    features: [
      'Track unlimited meetings',
      '1 calendar connection',
      'Basic ROI reports',
      'Email support',
    ],
    cta: 'Get Started',
  },
  {
    id: 'team',
    name: 'Team',
    priceLabel: '$149',
    description: 'For growing teams who value their time',
    features: [
      'Everything in Individual',
      'Up to 25 team members',
      'HRIS integration',
      'Task management sync',
      'Advanced governance rules',
      'Priority support',
    ],
    cta: 'Get Started',
    popular: true,
  },
  {
    id: 'enterprise',
    name: 'Enterprise',
    priceLabel: 'Custom',
    description: 'For organizations with complex needs',
    features: [
      'Everything in Team',
      'Unlimited team members',
      'Custom integrations',
      'Dedicated account manager',
      'SSO & advanced security',
      'SLA guarantee',
    ],
    cta: 'Contact Sales',
  },
];

interface PlanSelectionPageProps {
  organizationId: string;
}

export function PlanSelectionPage({ organizationId }: PlanSelectionPageProps) {
  const { data: session } = useSession();
  const [showEnterpriseForm, setShowEnterpriseForm] = useState(false);
  const [selectedPlan, setSelectedPlan] = useState<string | null>(null);
  const createCheckout = useCreateCheckoutSession();

  const handlePlanSelect = async (planId: string) => {
    if (planId === 'enterprise') {
      setShowEnterpriseForm(true);
      return;
    }

    if (!organizationId) {
      console.error('No organization ID available');
      return;
    }

    setSelectedPlan(planId);
    const planType = planId === 'individual' ? 'individual' : 'team';

    try {
      const result = await createCheckout.mutateAsync({
        organizationId,
        planType,
        successUrl: `${window.location.origin}/onboarding/setup-organization`,
        cancelUrl: `${window.location.origin}/onboarding/plan-selection`,
      });

      // Redirect to Stripe Checkout
      window.location.href = result.checkoutUrl;
    } catch (error) {
      console.error('Checkout error:', error);
      setSelectedPlan(null);
    }
  };

  if (showEnterpriseForm) {
    return (
      <EnterpriseForm
        organizationId={organizationId}
        onBack={() => setShowEnterpriseForm(false)}
      />
    );
  }

  return (
    <div className="space-y-8">
      <div className="text-center">
        <h1 className="text-3xl font-bold">Choose your plan</h1>
        <p className="mt-2 text-muted-foreground">
          Start tracking the true cost of your meetings
        </p>
      </div>

      <div className="grid gap-6 md:grid-cols-3 max-w-5xl mx-auto">
        {PLANS.map((plan) => (
          <PlanCard
            key={plan.id}
            {...plan}
            onSelect={() => handlePlanSelect(plan.id)}
            loading={createCheckout.isPending && selectedPlan === plan.id}
            disabled={createCheckout.isPending && selectedPlan !== plan.id}
          />
        ))}
      </div>
    </div>
  );
}
```

Create the Next.js page route in `apps/web/src/app/onboarding/plan-selection/page.tsx`:

```typescript
import { PlanSelectionPage } from '@/components/pages/onboarding/plan-selection';
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';

export default async function Page() {
  const session = await auth();

  if (!session?.user) {
    redirect('/login');
  }

  // Get organizationId from session or user data
  // For now, use a placeholder - this will be set during org creation in Phase 1
  const organizationId = (session.user as any).organizationId || '';

  return (
    <div className="container py-10">
      <PlanSelectionPage organizationId={organizationId} />
    </div>
  );
}
```

Note: The organizationId should come from the user's session after they create an organization in Phase 1. The exact session shape may need adjustment based on how Phase 1 stores organization data.
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim/apps/web && pnpm build` to verify compilation.
Check all three files exist in the correct locations.
  </verify>
  <done>
Plan selection page created with three pricing tiers.
Enterprise form submits contact requests.
Individual/Team plans redirect to Stripe Checkout.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes in apps/web
2. `/onboarding/plan-selection` route accessible
3. Three plan cards render with correct pricing
4. Clicking Individual/Team triggers checkout API call
5. Clicking Enterprise shows contact form
6. Enterprise form submits successfully
</verification>

<success_criteria>
- User sees three pricing cards (Individual $49, Team $149, Enterprise custom)
- Clicking Individual or Team initiates checkout flow
- Clicking Enterprise shows contact sales form
- Contact form validates input and submits to API
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-plan-billing/02-02-SUMMARY.md`
</output>
