---
phase: 02-plan-billing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/package.json
  - apps/api/src/lib/stripe.ts
  - apps/api/src/services/billing.service.ts
  - apps/api/src/routes/billing.route.ts
  - apps/api/src/routes/index.ts
  - packages/shared/src/types/billing.ts
  - packages/shared/src/schemas/billing.ts
  - packages/shared/src/index.ts
autonomous: true
requirements: [BILL-02, BILL-04]

user_setup:
  - service: stripe
    why: "Payment processing for subscription billing"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: STRIPE_PRICE_INDIVIDUAL
        source: "Stripe Dashboard -> Products -> Individual plan -> Price ID (e.g., price_xxx)"
      - name: STRIPE_PRICE_TEAM
        source: "Stripe Dashboard -> Products -> Team plan -> Price ID (e.g., price_xxx)"
    dashboard_config:
      - task: "Create Individual product with $49/month recurring price"
        location: "Stripe Dashboard -> Products -> Add product"
      - task: "Create Team product with $149/month recurring price"
        location: "Stripe Dashboard -> Products -> Add product"

must_haves:
  truths:
    - "API can create Stripe Checkout sessions for Individual and Team plans"
    - "Checkout session includes organizationId in metadata for webhook correlation"
    - "Checkout session returns a valid Stripe checkout URL"
  artifacts:
    - path: "apps/api/src/lib/stripe.ts"
      provides: "Stripe client initialization"
      contains: "new Stripe"
    - path: "apps/api/src/services/billing.service.ts"
      provides: "Billing business logic"
      exports: ["billingService"]
    - path: "apps/api/src/routes/billing.route.ts"
      provides: "Billing API endpoints"
      exports: ["billingRoutes"]
    - path: "packages/shared/src/types/billing.ts"
      provides: "Billing type definitions"
      exports: ["CheckoutSessionRequest", "CheckoutSessionResponse"]
    - path: "packages/shared/src/schemas/billing.ts"
      provides: "Billing validation schemas"
      exports: ["createCheckoutSessionSchema", "contactSalesSchema"]
  key_links:
    - from: "apps/api/src/routes/billing.route.ts"
      to: "apps/api/src/services/billing.service.ts"
      via: "service method call"
      pattern: "billingService\\.createCheckoutSession"
    - from: "apps/api/src/services/billing.service.ts"
      to: "apps/api/src/lib/stripe.ts"
      via: "stripe client"
      pattern: "stripe\\.checkout\\.sessions\\.create"
---

<objective>
Create Stripe backend infrastructure for subscription billing

Purpose: Enable the API to create Stripe Checkout sessions and manage subscription pricing
Output: Stripe service, billing routes, shared types and schemas for checkout flow
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plan-billing/02-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe SDK and Create Stripe Client</name>
  <files>
    apps/api/package.json
    apps/api/src/lib/stripe.ts
  </files>
  <action>
Install stripe package in the API app:
```bash
cd apps/api && pnpm add stripe
```

Create Stripe client initialization in `apps/api/src/lib/stripe.ts`:
- Import Stripe from 'stripe'
- Initialize with `STRIPE_SECRET_KEY` from environment
- Use apiVersion '2026-02-25.clover' (current stable)
- Export the stripe instance

Pattern to follow:
```typescript
import Stripe from 'stripe';

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2026-02-25.clover',
});
```
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim/apps/api && pnpm list stripe` to confirm package installed.
Check file exists with correct exports.
  </verify>
  <done>
Stripe SDK installed in apps/api. Stripe client exported from apps/api/src/lib/stripe.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Billing Types and Validation Schemas</name>
  <files>
    packages/shared/src/types/billing.ts
    packages/shared/src/schemas/billing.ts
    packages/shared/src/types/index.ts
    packages/shared/src/schemas/index.ts
    packages/shared/src/index.ts
  </files>
  <action>
Create billing types in `packages/shared/src/types/billing.ts`:

```typescript
// Plan types matching Stripe products
export type PlanType = 'individual' | 'team' | 'enterprise';

export interface CheckoutSessionRequest {
  organizationId: string;
  planType: Exclude<PlanType, 'enterprise'>; // Enterprise uses contact form
  successUrl: string;
  cancelUrl: string;
}

export interface CheckoutSessionResponse {
  checkoutUrl: string;
  sessionId: string;
}

export interface ContactSalesRequest {
  organizationId: string;
  name: string;
  email: string;
  company: string;
  message?: string;
}

export interface PortalSessionRequest {
  organizationId: string;
  returnUrl: string;
}

export interface PortalSessionResponse {
  portalUrl: string;
}
```

Create validation schemas in `packages/shared/src/schemas/billing.ts`:

```typescript
import { z } from 'zod';

export const planTypeSchema = z.enum(['individual', 'team', 'enterprise']);

export const createCheckoutSessionSchema = z.object({
  organizationId: z.string().min(1),
  planType: z.enum(['individual', 'team']), // Not enterprise
  successUrl: z.string().url(),
  cancelUrl: z.string().url(),
});

export const contactSalesSchema = z.object({
  organizationId: z.string().min(1),
  name: z.string().min(2, 'Name must be at least 2 characters'),
  email: z.string().email('Invalid email address'),
  company: z.string().min(2, 'Company name must be at least 2 characters'),
  message: z.string().optional(),
});

export const createPortalSessionSchema = z.object({
  organizationId: z.string().min(1),
  returnUrl: z.string().url(),
});

export type CreateCheckoutSessionInput = z.infer<typeof createCheckoutSessionSchema>;
export type ContactSalesInput = z.infer<typeof contactSalesSchema>;
export type CreatePortalSessionInput = z.infer<typeof createPortalSessionSchema>;
```

Update barrel exports:
- Add `export * from './billing'` to `packages/shared/src/types/index.ts`
- Add `export * from './billing'` to `packages/shared/src/schemas/index.ts`
- Ensure main index.ts re-exports both
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim && pnpm build --filter @klayim/shared` to confirm types compile.
  </verify>
  <done>
Billing types and schemas exported from @klayim/shared. TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Billing Service and API Routes</name>
  <files>
    apps/api/src/services/billing.service.ts
    apps/api/src/services/index.ts
    apps/api/src/routes/billing.route.ts
    apps/api/src/routes/index.ts
    apps/api/src/index.ts
  </files>
  <action>
Create billing service in `apps/api/src/services/billing.service.ts`:

```typescript
import { stripe } from '@/lib/stripe.js';
import type { CreateCheckoutSessionInput, ContactSalesInput, CreatePortalSessionInput } from '@klayim/shared/schemas';
import type Stripe from 'stripe';

// Map plan types to Stripe Price IDs from environment
const PRICE_MAP: Record<'individual' | 'team', string> = {
  individual: process.env.STRIPE_PRICE_INDIVIDUAL!,
  team: process.env.STRIPE_PRICE_TEAM!,
};

class BillingService {
  async createCheckoutSession(
    input: CreateCheckoutSessionInput,
    userId: string
  ): Promise<Stripe.Checkout.Session | { error: string }> {
    const priceId = PRICE_MAP[input.planType];

    if (!priceId) {
      return { error: `Invalid plan type: ${input.planType}` };
    }

    try {
      const session = await stripe.checkout.sessions.create({
        mode: 'subscription',
        line_items: [{ price: priceId, quantity: 1 }],
        success_url: `${input.successUrl}?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: input.cancelUrl,
        metadata: {
          organizationId: input.organizationId,
          userId,
          planType: input.planType,
        },
        subscription_data: {
          metadata: {
            organizationId: input.organizationId,
            userId,
            planType: input.planType,
          },
        },
      });

      return session;
    } catch (err) {
      console.error('Stripe checkout session error:', err);
      return { error: 'Failed to create checkout session' };
    }
  }

  async createPortalSession(
    input: CreatePortalSessionInput,
    customerId: string
  ): Promise<Stripe.BillingPortal.Session | { error: string }> {
    try {
      const session = await stripe.billingPortal.sessions.create({
        customer: customerId,
        return_url: input.returnUrl,
      });
      return session;
    } catch (err) {
      console.error('Stripe portal session error:', err);
      return { error: 'Failed to create portal session' };
    }
  }

  async submitContactSalesRequest(input: ContactSalesInput): Promise<void> {
    // For v1, log to console. In future, store in Firestore or send to CRM
    console.log('Enterprise contact request:', JSON.stringify(input, null, 2));
    // TODO: Store in Firestore enterprise_leads collection
  }
}

export const billingService = new BillingService();
```

Update `apps/api/src/services/index.ts` to export billingService.

Create billing routes in `apps/api/src/routes/billing.route.ts`:

```typescript
import { Hono } from 'hono';
import { zValidator } from '@hono/zod-validator';
import { createCheckoutSessionSchema, contactSalesSchema } from '@klayim/shared/schemas';
import type { ApiResponse, CheckoutSessionResponse } from '@klayim/shared/types';
import { billingService } from '@/services/index.js';

const billing = new Hono();

// POST /billing/checkout - Create checkout session (requires auth)
billing.post(
  '/checkout',
  zValidator('json', createCheckoutSessionSchema),
  async (c) => {
    const userId = c.get('userId') as string | undefined;
    if (!userId) {
      return c.json<ApiResponse<null>>({ success: false, error: 'Unauthorized' }, 401);
    }

    const input = c.req.valid('json');
    const result = await billingService.createCheckoutSession(input, userId);

    if ('error' in result) {
      return c.json<ApiResponse<null>>({ success: false, error: result.error }, 400);
    }

    return c.json<ApiResponse<CheckoutSessionResponse>>({
      success: true,
      data: {
        checkoutUrl: result.url!,
        sessionId: result.id,
      },
    });
  }
);

// POST /billing/contact-sales - Enterprise contact request (no auth required)
billing.post(
  '/contact-sales',
  zValidator('json', contactSalesSchema),
  async (c) => {
    const input = c.req.valid('json');
    await billingService.submitContactSalesRequest(input);

    return c.json<ApiResponse<null>>({
      success: true,
      message: 'Contact request submitted successfully',
    });
  }
);

export { billing as billingRoutes };
```

Update `apps/api/src/routes/index.ts` to export billingRoutes.

Update `apps/api/src/index.ts` to mount billing routes:
- Import `billingRoutes` from routes
- Mount with auth middleware: `app.route('/billing', authMiddleware, billingRoutes)`
- Note: /billing/checkout requires auth, but contact-sales is public so add auth check inside route handler instead of middleware
- Mount billing routes WITHOUT global auth: `app.route('/billing', billingRoutes)` and handle auth per-route
  </action>
  <verify>
Run `cd /Users/ardiansyahiqbal/dev-app/myx/klayim/apps/api && pnpm build` to confirm compilation.
Check that routes are mounted by reviewing apps/api/src/index.ts.
  </verify>
  <done>
Billing service created with createCheckoutSession and submitContactSalesRequest methods.
Billing routes mounted at /billing/checkout and /billing/contact-sales.
API builds successfully.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes in apps/api
2. `pnpm build` passes in packages/shared
3. Stripe package listed in apps/api/package.json dependencies
4. billingRoutes exported from apps/api/src/routes/index.ts
5. billingService exported from apps/api/src/services/index.ts
</verification>

<success_criteria>
- Stripe SDK installed and client initialized
- Billing types and schemas available in @klayim/shared
- POST /billing/checkout endpoint creates Stripe Checkout sessions
- POST /billing/contact-sales endpoint accepts enterprise contact requests
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-plan-billing/02-01-SUMMARY.md`
</output>
