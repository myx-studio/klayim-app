---
phase: 05-calendar-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/package.json
  - packages/shared/src/types/calendar.ts
  - packages/shared/src/types/index.ts
  - apps/api/src/services/google-calendar.service.ts
  - apps/api/src/services/microsoft-calendar.service.ts
  - apps/api/src/routes/oauth/google.ts
  - apps/api/src/routes/oauth/microsoft.ts
  - apps/api/src/routes/oauth/index.ts
  - apps/api/src/routes/index.ts
  - apps/api/src/index.ts
  - apps/api/src/services/index.ts
  - apps/api/src/services/token-refresh.service.ts
autonomous: true
requirements: [CAL-01, CAL-02]

must_haves:
  truths:
    - "User clicking 'Connect' on Google calendar card is redirected to Google OAuth consent"
    - "User clicking 'Connect' on Microsoft calendar card is redirected to Microsoft OAuth consent"
    - "After OAuth consent, user tokens are encrypted and stored in integrations collection"
    - "User's calendar account email is displayed after successful connection"
  artifacts:
    - path: "packages/shared/src/types/calendar.ts"
      provides: "CalendarEvent, SyncState types for event storage"
      contains: "interface CalendarEvent"
    - path: "apps/api/src/services/google-calendar.service.ts"
      provides: "Google Calendar API client with OAuth and token management"
      exports: ["googleCalendarService"]
    - path: "apps/api/src/services/microsoft-calendar.service.ts"
      provides: "Microsoft Graph Calendar client with OAuth and token management"
      exports: ["microsoftCalendarService"]
    - path: "apps/api/src/routes/oauth/google.ts"
      provides: "Google OAuth authorization and callback endpoints"
      exports: ["googleOAuth"]
    - path: "apps/api/src/routes/oauth/microsoft.ts"
      provides: "Microsoft OAuth authorization and callback endpoints"
      exports: ["microsoftOAuth"]
  key_links:
    - from: "apps/api/src/routes/oauth/google.ts"
      to: "apps/api/src/services/google-calendar.service.ts"
      via: "getAuthUrl, exchangeCode calls"
      pattern: "googleCalendarService\\.(getAuthUrl|exchangeCode)"
    - from: "apps/api/src/routes/oauth/microsoft.ts"
      to: "apps/api/src/services/microsoft-calendar.service.ts"
      via: "getAuthUrl, exchangeCode calls"
      pattern: "microsoftCalendarService\\.(getAuthUrl|exchangeCode)"
    - from: "apps/api/src/routes/oauth/*.ts"
      to: "apps/api/src/services/integration.service.ts"
      via: "connect() to store encrypted tokens"
      pattern: "integrationService\\.connect"
---

<objective>
Install calendar SDKs, create OAuth services for Google and Microsoft, and implement authorization endpoints that enable users to connect their calendars.

Purpose: Establish the OAuth flows that users will use to authorize calendar access during onboarding.
Output: Working /api/oauth/google and /api/oauth/microsoft endpoints that handle authorization and callback flows.
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-calendar-integration/05-RESEARCH.md
@.planning/phases/04-integration-infrastructure/04-02-SUMMARY.md
@.planning/phases/04-integration-infrastructure/04-03-SUMMARY.md

@apps/api/src/services/integration.service.ts
@apps/api/src/services/token-refresh.service.ts
@apps/api/src/repositories/integration.repository.ts
@packages/shared/src/types/integration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install calendar SDKs and create CalendarEvent types</name>
  <files>
    apps/api/package.json
    packages/shared/src/types/calendar.ts
    packages/shared/src/types/index.ts
  </files>
  <action>
    Install required packages in apps/api:
    ```bash
    cd apps/api && pnpm add googleapis @azure/msal-node @microsoft/microsoft-graph-client
    ```

    Create `packages/shared/src/types/calendar.ts` with:

    1. CalendarEvent interface (normalized for both providers):
       - id: string
       - organizationId: string
       - integrationId: string (which calendar this came from)
       - externalId: string (provider's event ID)
       - provider: 'google_calendar' | 'microsoft_calendar'
       - title: string
       - startTime: string (ISO datetime)
       - endTime: string (ISO datetime)
       - durationMinutes: number
       - isAllDay: boolean
       - organizerEmail: string
       - attendees: Array<{ email: string; responseStatus: 'accepted' | 'declined' | 'tentative' | 'needsAction' }>
       - recurringEventId?: string (ID of master event if recurring)
       - status: 'confirmed' | 'tentative' | 'cancelled'
       - createdAt: string
       - updatedAt: string
       - calculatedCostCents?: number (for cost calculation later)

    2. SyncState interface (track sync tokens per integration):
       - id: string (same as integrationId)
       - organizationId: string
       - integrationId: string
       - syncToken?: string (Google)
       - deltaLink?: string (Microsoft)
       - lastFullSyncAt?: string
       - lastIncrementalSyncAt?: string
       - lastSyncError?: string
       - webhookChannelId?: string
       - webhookResourceId?: string (Google resourceId for stop)
       - webhookExpiration?: string
       - createdAt: string
       - updatedAt: string

    Export both from packages/shared/src/types/index.ts
  </action>
  <verify>
    `cd apps/api && pnpm build` succeeds
    `grep "CalendarEvent" packages/shared/src/types/index.ts` shows export
  </verify>
  <done>
    CalendarEvent and SyncState types exist in shared package
    googleapis, @azure/msal-node, @microsoft/microsoft-graph-client installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Google Calendar service with OAuth flow</name>
  <files>
    apps/api/src/services/google-calendar.service.ts
    apps/api/src/routes/oauth/google.ts
    apps/api/src/routes/oauth/index.ts
    apps/api/src/routes/index.ts
    apps/api/src/index.ts
    apps/api/src/services/index.ts
    apps/api/src/services/token-refresh.service.ts
  </files>
  <action>
    Create `apps/api/src/services/google-calendar.service.ts`:

    1. Import { google } from 'googleapis' and OAuth2 client
    2. Create class GoogleCalendarService with:
       - private createOAuth2Client() - creates OAuth2 client with env vars
       - getAuthUrl(state: string): string - generates consent URL with:
         - access_type: 'offline' (required for refresh token)
         - prompt: 'consent' (force to get refresh token)
         - scope: 'https://www.googleapis.com/auth/calendar.readonly'
         - state parameter (JSON with organizationId, redirectUrl)
       - async exchangeCode(code: string): Promise<{ tokens, userInfo }> - exchanges code for tokens, fetches user info
       - async createOAuth2ClientWithToken(accessToken: string, refreshToken: string): google.auth.OAuth2 - for API calls
       - async refreshToken(refreshToken: string): Promise<{ accessToken, expiresInMs }> - refresh flow

    3. Use environment variables: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, API_URL

    Create `apps/api/src/routes/oauth/google.ts` (Hono router):

    1. GET /authorize - generates auth URL, returns { url }
       - Requires authenticated user (use authMiddleware from existing patterns)
       - Takes organizationId from query param
       - State includes organizationId and frontend callback URL

    2. GET /callback - handles OAuth callback
       - Exchanges code for tokens
       - Gets user email from Google
       - Calls integrationService.connect() with encrypted credentials
       - Redirects to frontend with success/error

    Create `apps/api/src/routes/oauth/index.ts` - mounts google and microsoft routers
    Update `apps/api/src/routes/index.ts` to export oauth
    Update `apps/api/src/index.ts` to mount oauth routes at /api/oauth

    Update token-refresh.service.ts refreshGoogleToken():
    - Replace stub with actual implementation using googleapis
    - Use google.auth.OAuth2 with refresh_token to get new access_token
  </action>
  <verify>
    `cd apps/api && pnpm build` succeeds
    `grep "getAuthUrl" apps/api/src/services/google-calendar.service.ts` exists
    `grep "refreshGoogleToken" apps/api/src/services/token-refresh.service.ts` shows implementation
  </verify>
  <done>
    Google OAuth flow implemented with authorize and callback endpoints
    Token refresh actually works (no more stub error)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Microsoft Calendar service with OAuth flow</name>
  <files>
    apps/api/src/services/microsoft-calendar.service.ts
    apps/api/src/routes/oauth/microsoft.ts
    apps/api/src/routes/oauth/index.ts
    apps/api/src/services/index.ts
    apps/api/src/services/token-refresh.service.ts
  </files>
  <action>
    Create `apps/api/src/services/microsoft-calendar.service.ts`:

    1. Import ConfidentialClientApplication from '@azure/msal-node'
    2. Import Client from '@microsoft/microsoft-graph-client'
    3. Create class MicrosoftCalendarService with:
       - private createMsalClient() - creates ConfidentialClientApplication
       - async getAuthUrl(state: string): Promise<string> - generates consent URL with:
         - scopes: ['Calendars.Read', 'offline_access', 'User.Read']
         - authority: 'https://login.microsoftonline.com/common' (multi-tenant)
         - state parameter (JSON with organizationId, redirectUrl)
       - async exchangeCode(code: string): Promise<{ tokens, userInfo }> - exchanges code, fetches /me
       - async refreshToken(refreshToken: string, scopes: string[]): Promise<{ accessToken, expiresInMs }> - refresh flow
       - createGraphClient(accessToken: string): Client - for API calls

    4. Use environment variables: MICROSOFT_CLIENT_ID, MICROSOFT_CLIENT_SECRET, API_URL

    Create `apps/api/src/routes/oauth/microsoft.ts` (Hono router):

    1. GET /authorize - generates auth URL, returns { url }
       - Takes organizationId from query param
       - State includes organizationId and frontend callback URL

    2. GET /callback - handles OAuth callback
       - Exchanges code for tokens
       - Gets user info from Graph API /me
       - Calls integrationService.connect() with encrypted credentials
       - Redirects to frontend with success/error

    Update `apps/api/src/routes/oauth/index.ts` to mount microsoft router

    Update token-refresh.service.ts refreshMicrosoftToken():
    - Replace stub with actual implementation using MSAL acquireTokenByRefreshToken
    - Note: MSAL caches tokens internally but we need explicit refresh for our storage

    Export both services from apps/api/src/services/index.ts
  </action>
  <verify>
    `cd apps/api && pnpm build` succeeds
    `grep "getAuthUrl" apps/api/src/services/microsoft-calendar.service.ts` exists
    `grep "refreshMicrosoftToken" apps/api/src/services/token-refresh.service.ts` shows implementation
  </verify>
  <done>
    Microsoft OAuth flow implemented with authorize and callback endpoints
    Both Google and Microsoft token refresh working
    OAuth routes mounted at /api/oauth/google and /api/oauth/microsoft
  </done>
</task>

</tasks>

<verification>
1. Build passes: `cd apps/api && pnpm build`
2. Types exported: `grep -E "(CalendarEvent|SyncState)" packages/shared/src/types/index.ts`
3. OAuth routes mounted: Check apps/api/src/index.ts imports oauth routes
4. No stub errors remain in token-refresh.service.ts for Google/Microsoft
</verification>

<success_criteria>
- googleapis, @azure/msal-node, @microsoft/microsoft-graph-client are installed
- CalendarEvent and SyncState types exist in shared package
- /api/oauth/google/authorize returns authorization URL
- /api/oauth/google/callback exchanges code and stores encrypted tokens
- /api/oauth/microsoft/authorize returns authorization URL
- /api/oauth/microsoft/callback exchanges code and stores encrypted tokens
- Token refresh implementations work for both providers
</success_criteria>

<output>
After completion, create `.planning/phases/05-calendar-integration/05-01-SUMMARY.md`
</output>
