---
phase: 05-calendar-integration
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - apps/api/src/repositories/calendar-event.repository.ts
  - apps/api/src/repositories/sync-state.repository.ts
  - apps/api/src/repositories/index.ts
  - apps/api/src/services/calendar-sync.service.ts
  - apps/api/src/services/google-calendar.service.ts
  - apps/api/src/services/microsoft-calendar.service.ts
  - apps/api/src/services/index.ts
  - apps/api/src/routes/oauth/google.ts
  - apps/api/src/routes/oauth/microsoft.ts
  - firestore.rules
autonomous: true
requirements: [CAL-03]

must_haves:
  truths:
    - "After OAuth callback, system performs initial full sync of calendar events"
    - "Calendar events are stored with title, attendees, and duration"
    - "Sync state tracks syncToken/deltaLink for incremental sync"
    - "Events include organizationId for multi-tenant isolation"
  artifacts:
    - path: "apps/api/src/repositories/calendar-event.repository.ts"
      provides: "CalendarEvent CRUD with organizationId scoping"
      exports: ["calendarEventRepository"]
    - path: "apps/api/src/repositories/sync-state.repository.ts"
      provides: "SyncState CRUD for tracking sync tokens"
      exports: ["syncStateRepository"]
    - path: "apps/api/src/services/calendar-sync.service.ts"
      provides: "Full and incremental sync orchestration"
      exports: ["calendarSyncService"]
  key_links:
    - from: "apps/api/src/services/calendar-sync.service.ts"
      to: "apps/api/src/services/google-calendar.service.ts"
      via: "listEvents call for sync"
      pattern: "googleCalendarService\\.listEvents"
    - from: "apps/api/src/services/calendar-sync.service.ts"
      to: "apps/api/src/services/microsoft-calendar.service.ts"
      via: "listEvents call for sync"
      pattern: "microsoftCalendarService\\.listEvents"
    - from: "apps/api/src/routes/oauth/*.ts"
      to: "apps/api/src/services/calendar-sync.service.ts"
      via: "triggerInitialSync after connect"
      pattern: "calendarSyncService\\.(fullSync|triggerInitialSync)"
---

<objective>
Create calendar event storage, sync state tracking, and implement full/incremental sync logic that imports meetings from Google and Microsoft calendars.

Purpose: Enable the system to actually fetch and store calendar events after a user connects their calendar.
Output: Calendar events stored in Firestore with all meeting metadata needed for cost calculation.
</objective>

<execution_context>
@/Users/ardiansyahiqbal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ardiansyahiqbal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-calendar-integration/05-RESEARCH.md
@.planning/phases/05-calendar-integration/05-01-SUMMARY.md

@packages/shared/src/types/calendar.ts
@apps/api/src/services/google-calendar.service.ts
@apps/api/src/services/microsoft-calendar.service.ts
@apps/api/src/repositories/integration.repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CalendarEvent and SyncState repositories</name>
  <files>
    apps/api/src/repositories/calendar-event.repository.ts
    apps/api/src/repositories/sync-state.repository.ts
    apps/api/src/repositories/index.ts
    firestore.rules
  </files>
  <action>
    Create `apps/api/src/repositories/calendar-event.repository.ts`:

    1. Collection: 'calendar_events'
    2. Methods:
       - create(event: Omit<CalendarEvent, 'id' | 'createdAt' | 'updatedAt'>): Promise<CalendarEvent>
       - findById(id: string): Promise<CalendarEvent | null>
       - findByOrganization(organizationId: string, limit?: number): Promise<CalendarEvent[]>
       - findByIntegration(integrationId: string): Promise<CalendarEvent[]>
       - findByExternalId(integrationId: string, externalId: string): Promise<CalendarEvent | null>
       - upsertByExternalId(integrationId: string, externalId: string, data: Partial<CalendarEvent>): Promise<CalendarEvent>
         - Creates if not exists, updates if exists (for idempotent sync)
       - deleteByIntegration(integrationId: string): Promise<number> - bulk delete on disconnect
       - deleteCancelled(integrationId: string): Promise<number> - clean up cancelled events

    3. All queries include organizationId for multi-tenant isolation

    Create `apps/api/src/repositories/sync-state.repository.ts`:

    1. Collection: 'sync_states'
    2. Methods:
       - create(state: Omit<SyncState, 'id' | 'createdAt' | 'updatedAt'>): Promise<SyncState>
       - findByIntegration(integrationId: string): Promise<SyncState | null>
       - update(integrationId: string, data: Partial<SyncState>): Promise<void>
       - updateSyncToken(integrationId: string, token: { syncToken?: string; deltaLink?: string }): Promise<void>
       - updateWebhookState(integrationId: string, webhook: { channelId?: string; resourceId?: string; expiration?: string }): Promise<void>
       - delete(integrationId: string): Promise<void>

    Export both from apps/api/src/repositories/index.ts

    Update firestore.rules to add calendar_events and sync_states collections:
    - organizationId isolation (same pattern as other collections)
    - Only org members can read
    - Only admins can write (or service account)
  </action>
  <verify>
    `cd apps/api && pnpm build` succeeds
    `grep "calendarEventRepository" apps/api/src/repositories/index.ts` exists
    `grep "calendar_events" firestore.rules` shows rules
  </verify>
  <done>
    CalendarEvent repository with upsert for idempotent sync
    SyncState repository for tracking sync tokens
    Firestore rules updated for new collections
  </done>
</task>

<task type="auto">
  <name>Task 2: Add event listing methods to calendar services</name>
  <files>
    apps/api/src/services/google-calendar.service.ts
    apps/api/src/services/microsoft-calendar.service.ts
  </files>
  <action>
    Update `apps/api/src/services/google-calendar.service.ts`:

    1. Add method listEvents(accessToken: string, options: { syncToken?: string }): Promise<{ events: RawGoogleEvent[], nextSyncToken: string }>
       - Uses calendar.events.list API
       - If syncToken provided: incremental sync
       - If no syncToken: full sync with timeMin = 90 days ago
       - Handle 410 GONE by returning { events: [], nextSyncToken: '', needsFullSync: true }
       - Use singleEvents: true to expand recurring events
       - Paginate through all results using nextPageToken

    2. Add method mapToCalendarEvent(googleEvent: any, integrationId: string, organizationId: string): CalendarEvent
       - Maps Google event format to normalized CalendarEvent
       - Handle attendees array mapping (email, responseStatus)
       - Calculate durationMinutes from start/end
       - Handle all-day events (dateTime vs date)

    Update `apps/api/src/services/microsoft-calendar.service.ts`:

    1. Add method listEvents(accessToken: string, options: { deltaLink?: string }): Promise<{ events: RawMicrosoftEvent[], nextDeltaLink: string }>
       - Uses /me/calendarView/delta API
       - If deltaLink provided: incremental sync
       - If no deltaLink: full sync with startDateTime = 90 days ago, endDateTime = 365 days future
       - Handle @odata.nextLink for pagination
       - Return @odata.deltaLink for next sync

    2. Add method mapToCalendarEvent(msEvent: any, integrationId: string, organizationId: string): CalendarEvent
       - Maps Microsoft event format to normalized CalendarEvent
       - Handle attendees array mapping (emailAddress.address, status.response)
       - Calculate durationMinutes from start/end
       - Handle isAllDay flag
  </action>
  <verify>
    `cd apps/api && pnpm build` succeeds
    `grep "listEvents" apps/api/src/services/google-calendar.service.ts` exists
    `grep "mapToCalendarEvent" apps/api/src/services/microsoft-calendar.service.ts` exists
  </verify>
  <done>
    Google listEvents with syncToken support for incremental sync
    Microsoft listEvents with deltaLink support for incremental sync
    Both services can map provider events to normalized CalendarEvent
  </done>
</task>

<task type="auto">
  <name>Task 3: Create calendar sync service and trigger initial sync</name>
  <files>
    apps/api/src/services/calendar-sync.service.ts
    apps/api/src/services/index.ts
    apps/api/src/routes/oauth/google.ts
    apps/api/src/routes/oauth/microsoft.ts
  </files>
  <action>
    Create `apps/api/src/services/calendar-sync.service.ts`:

    1. Import calendarEventRepository, syncStateRepository, googleCalendarService, microsoftCalendarService, tokenRefreshService

    2. Methods:
       - async fullSync(integrationId: string): Promise<{ eventsImported: number }>
         - Get integration from repository
         - Get valid access token via tokenRefreshService.getValidToken()
         - Call appropriate provider's listEvents (no syncToken = full sync)
         - Upsert all events to calendar_events collection
         - Create/update sync state with new syncToken/deltaLink
         - Record lastFullSyncAt

       - async incrementalSync(integrationId: string): Promise<{ eventsUpdated: number }>
         - Get sync state for stored syncToken/deltaLink
         - Get valid access token
         - Call listEvents with token
         - Handle 410 GONE: clear events, perform full sync
         - Upsert changed events
         - Handle deleted events (status = cancelled)
         - Update sync state with new token
         - Record lastIncrementalSyncAt

       - async triggerInitialSync(integrationId: string): Promise<void>
         - Creates sync state record
         - Calls fullSync
         - Logs completion

    3. Export calendarSyncService singleton

    Update OAuth callback handlers (google.ts, microsoft.ts):
    - After successful integrationService.connect()
    - Call calendarSyncService.triggerInitialSync(integration.id)
    - This happens async (don't await - redirect immediately)

    Export calendarSyncService from apps/api/src/services/index.ts
  </action>
  <verify>
    `cd apps/api && pnpm build` succeeds
    `grep "fullSync" apps/api/src/services/calendar-sync.service.ts` exists
    `grep "triggerInitialSync" apps/api/src/routes/oauth/google.ts` exists
  </verify>
  <done>
    Calendar sync service handles full and incremental sync for both providers
    OAuth callbacks trigger initial sync after successful connection
    Sync state properly tracks tokens for incremental updates
  </done>
</task>

</tasks>

<verification>
1. Build passes: `cd apps/api && pnpm build`
2. Repositories exported: `grep -E "(calendarEventRepository|syncStateRepository)" apps/api/src/repositories/index.ts`
3. Sync service exported: `grep "calendarSyncService" apps/api/src/services/index.ts`
4. Firestore rules include new collections: `grep -E "(calendar_events|sync_states)" firestore.rules`
</verification>

<success_criteria>
- calendar_events and sync_states collections have repositories
- Google events.list works with syncToken for incremental sync
- Microsoft calendarView/delta works with deltaLink for incremental sync
- Events are normalized to CalendarEvent type regardless of provider
- Initial sync triggered automatically after OAuth connection
- 410 GONE errors trigger automatic full re-sync
</success_criteria>

<output>
After completion, create `.planning/phases/05-calendar-integration/05-02-SUMMARY.md`
</output>
